---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import MessageButton from '../../components/MessageButton.astro';
import ImageViewer from '../../components/ImageViewer.astro';
import { supabase } from '../../lib/supabase';

// Force no-cache
Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

const { id } = Astro.params;

// Get current user
const { data: sessionData } = await supabase.auth.getSession();
const currentUser = sessionData?.session?.user;
const isOwner = currentUser?.id === id;

// Fetch profile
const { data: profile, error: profileError } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', id)
  .maybeSingle();

if (profileError || !profile) return Astro.redirect('/404');

// Fetch projects
const { data: projects } = await supabase
  .from('projects')
  .select('*')
  .eq('user_id', id)
  .order('created_at', { ascending: false });

// Fetch posts
const { data: userPosts } = await supabase
  .from('posts')
  .select(`*, communities (name), image_urls`)
  .eq('user_id', id)
  .order('created_at', { ascending: false });

const displayName = profile.full_name || profile.username || "Unknown";

// Generate emoji avatar
const emojis = ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ¥³', 'ðŸ˜', 'ðŸ˜’', 'ðŸ˜ž', 'ðŸ˜”', 'ðŸ˜Ÿ', 'ðŸ˜•', 'ðŸ™', 'â˜¹ï¸', 'ðŸ˜£', 'ðŸ˜–', 'ðŸ˜«', 'ðŸ˜©', 'ðŸ¥º', 'ðŸ˜¢', 'ðŸ˜­', 'ðŸ˜¤', 'ðŸ˜ ', 'ðŸ˜¡', 'ðŸ¤¬', 'ðŸ¤¯', 'ðŸ˜³', 'ðŸ¥µ', 'ðŸ¥¶', 'ðŸ˜±', 'ðŸ˜¨', 'ðŸ˜°', 'ðŸ˜¥', 'ðŸ˜“', 'ðŸ¤—', 'ðŸ¤”', 'ðŸ¤­', 'ðŸ¤«', 'ðŸ¤¥', 'ðŸ˜¶', 'ðŸ˜', 'ðŸ˜‘', 'ðŸ˜¬', 'ðŸ™„', 'ðŸ˜¯', 'ðŸ˜¦', 'ðŸ˜§', 'ðŸ˜®', 'ðŸ˜²', 'ðŸ¥±', 'ðŸ˜´', 'ðŸ¤¤', 'ðŸ˜ª', 'ðŸ˜µ', 'ðŸ¤', 'ðŸ¥´', 'ðŸ¤¢', 'ðŸ¤®', 'ðŸ¤§', 'ðŸ˜·', 'ðŸ¤’', 'ðŸ¤•', 'ðŸ¤‘', 'ðŸ¤ ', 'ðŸ˜ˆ', 'ðŸ‘¿', 'ðŸ‘¹', 'ðŸ‘º', 'ðŸ¤¡', 'ðŸ’©', 'ðŸ‘»', 'ðŸ’€', 'â˜ ï¸', 'ðŸ‘½', 'ðŸ‘¾', 'ðŸ¤–', 'ðŸŽƒ', 'ðŸ˜º', 'ðŸ˜¸', 'ðŸ˜¹', 'ðŸ˜»', 'ðŸ˜¼', 'ðŸ˜½', 'ðŸ™€', 'ðŸ˜¿', 'ðŸ˜¾'];

function getEmojiAvatar(username) {
  if (!username) username = 'user';
  const hash = String(username).split('').reduce((a, b) => a + b.charCodeAt(0), 0);
  const emoji = emojis[hash % emojis.length];
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="#f3f4f6"/><text x="50" y="65" font-size="50" text-anchor="middle">${emoji}</text></svg>`;
  return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
}
---

<BaseLayout title={displayName}>
  
  <!-- Hero Section with Banner -->
  <div class="bg-stone-50 dark:bg-stone-900 border-b border-stone-200 dark:border-stone-700">

    <!-- Banner -->
    <div class="relative group h-48 md:h-64 w-full bg-stone-200 dark:bg-stone-800 overflow-hidden">
      {profile.banner_url ? (
        <img
          src={profile.banner_url}
          class="w-full h-full object-cover"
          alt="Profile Banner"
        />
      ) : (
        <div class="w-full h-full bg-gradient-to-br from-stone-200 via-stone-100 to-stone-300 dark:from-stone-800 dark:via-stone-900 dark:to-stone-700"></div>
      )}

      {isOwner && (
        <a href="/settings" class="absolute top-4 right-4 bg-stone-800/80 dark:bg-stone-200/80 hover:bg-stone-800 dark:hover:bg-stone-200 text-stone-50 dark:text-stone-900 px-4 py-2 rounded-xl font-normal text-sm transition-all">
          Edit Cover
        </a>
      )}
    </div>

    <!-- Profile Info -->
    <div class="max-w-4xl mx-auto px-6">
      <div class="flex flex-col md:flex-row items-start gap-6 -mt-16 pb-8">
        
        <!-- Avatar -->
        <div class="relative">
          <div class="w-28 h-28 md:w-32 md:h-32 rounded-2xl border-4 border-stone-50 dark:border-stone-900 bg-stone-50 dark:bg-stone-900 overflow-hidden flex items-center justify-center shadow-lg">
            {profile.avatar_url ? (
              <img src={profile.avatar_url} class="w-full h-full object-cover" alt="Profile" />
            ) : (
              <img src={getEmojiAvatar(profile.username || 'user')} class="w-full h-full object-cover" alt="Avatar" />
            )}
          </div>
        </div>

        <!-- Profile Details -->
        <div class="flex-1 pt-12 md:pt-4">
          <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
            <div class="flex-1">
              <h1 class="text-2xl md:text-3xl font-normal text-stone-800 dark:text-stone-200 leading-tight">{displayName}</h1>
              <p class="text-stone-500 dark:text-stone-400 font-normal mb-3">@{profile.username || 'user'}</p>
              {profile.bio && (
                <p class="text-stone-600 dark:text-stone-400 max-w-2xl leading-relaxed font-normal">{profile.bio}</p>
              )}
            </div>
            
            <!-- Action Buttons -->
            <div class="flex gap-3 flex-shrink-0">
              {isOwner ? (
                <a href="/settings" class="px-6 py-3 text-base font-normal border border-stone-300 dark:border-stone-600 rounded-xl hover:bg-stone-100 dark:hover:bg-stone-800 transition-colors text-stone-700 dark:text-stone-300">
                  Edit Profile
                </a>
              ) : currentUser ? (
                <>
                  <button class="px-6 py-3 text-base font-normal bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 rounded-xl hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
                    Follow
                  </button>
                  <MessageButton userId={id} username={profile.username || 'user'} variant="secondary" size="sm" />
                </>
              ) : null}
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="flex gap-8 border-b border-stone-200 dark:border-stone-700 text-base font-normal">
        <button class="tab-btn active-tab pb-4 border-b-2 border-stone-800 dark:border-stone-200 text-stone-800 dark:text-stone-200" data-target="tab-portfolio">
          Portfolio <span class="ml-2 text-stone-400 dark:text-stone-500 text-sm">{projects?.length || 0}</span>
        </button>
        <button class="tab-btn pb-4 border-b-2 border-transparent text-stone-500 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200 transition-colors" data-target="tab-posts">
          Posts <span class="ml-2 text-stone-400 dark:text-stone-500 text-sm">{userPosts?.length || 0}</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Content Area -->
  <div class="max-w-4xl mx-auto px-6 py-12 min-h-[500px]">
    
    <!-- Portfolio Tab -->
    <div id="tab-portfolio" class="tab-content">
      {projects && projects.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          {projects.map((p) => <ProjectCard project={p} />)}
        </div>
      ) : (
        <div class="text-center py-20 bg-stone-100 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-2xl">
          <div class="w-16 h-16 bg-stone-200 dark:bg-stone-700 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
          </div>
          <h3 class="text-lg font-normal text-stone-800 dark:text-stone-200 mb-2">No work shared yet</h3>
          <p class="text-stone-600 dark:text-stone-400 font-normal">
            {isOwner ? "Share your first project to get started." : "This artist hasn't shared any work yet."}
          </p>
          {isOwner && (
            <a href="/post" class="inline-block mt-6 px-6 py-3 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 rounded-xl font-normal hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
              Share Your Work
            </a>
          )}
        </div>
      )}
    </div>

    <!-- Posts Tab -->
    <div id="tab-posts" class="tab-content hidden">
      {userPosts && userPosts.length > 0 ? (
        <div class="space-y-6">
          {userPosts.map(post => (
            <a href={`/post/${post.id}`} class="block border border-stone-200 dark:border-stone-700 p-6 rounded-2xl hover:bg-stone-50 dark:hover:bg-stone-750 hover:border-stone-300 dark:hover:border-stone-600 transition-all cursor-pointer">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-xl bg-stone-200 dark:bg-stone-700 overflow-hidden border border-stone-300 dark:border-stone-600">
                  <img src={profile.avatar_url || getEmojiAvatar(profile.username || 'user')} class="w-full h-full object-cover" />
                </div>
                <div>
                  <div class="font-normal text-stone-800 dark:text-stone-200 leading-tight">{displayName}</div>
                  <div class="flex items-center gap-2 text-xs text-stone-500 dark:text-stone-400 font-normal">
                    <span>{new Date(post.created_at).toLocaleDateString()}</span>
                    {post.communities && (
                      <>
                        <span>â€¢</span>
                        <span class="hover:text-stone-700 dark:hover:text-stone-300 transition-colors">in c/{post.communities.name}</span>
                      </>
                    )}
                  </div>
                </div>
              </div>
              <p class="text-stone-600 dark:text-stone-300 text-base leading-relaxed whitespace-pre-wrap font-normal mb-4">{post.content}</p>
              {(post.image_urls && post.image_urls.length > 0) ? (
                <div class="mb-4">
                  <ImageViewer images={post.image_urls} title={`Post by ${displayName}`} />
                </div>
              ) : post.image_url ? (
                <div class="mb-4">
                  <ImageViewer images={[post.image_url]} title={`Post by ${displayName}`} />
                </div>
              ) : null}
              <div class="flex items-center gap-6 pt-3 border-t border-stone-200 dark:border-stone-700 text-sm text-stone-500 dark:text-stone-400 font-normal">
                <div class="flex items-center gap-2 hover:text-stone-700 dark:hover:text-stone-300 transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                  </svg>
                  <span>Reply</span>
                </div>
                <div class="flex items-center gap-2 hover:text-stone-700 dark:hover:text-stone-300 transition-colors">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                  </svg>
                  <span>Like</span>
                </div>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="text-center py-20 bg-stone-100 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-2xl">
          <div class="w-16 h-16 bg-stone-200 dark:bg-stone-700 rounded-2xl flex items-center justify-center mx-auto mb-6">
            <svg class="w-8 h-8 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
          </div>
          <h3 class="text-lg font-normal text-stone-800 dark:text-stone-200 mb-2">No posts yet</h3>
          <p class="text-stone-600 dark:text-stone-400 font-normal">
            {isOwner ? "Share your thoughts with the community." : "This artist hasn't posted anything yet."}
          </p>
          {isOwner && (
            <a href="/communities" class="inline-block mt-6 px-6 py-3 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 rounded-xl font-normal hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
              Join Communities
            </a>
          )}
        </div>
      )}
    </div>

  </div>

</BaseLayout>

<script>
  // Tab switching logic
  const tabs = document.querySelectorAll('.tab-btn');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Reset all tabs
      tabs.forEach(t => {
        t.classList.remove('border-stone-800', 'dark:border-stone-200', 'text-stone-800', 'dark:text-stone-200');
        t.classList.add('border-transparent', 'text-stone-500', 'dark:text-stone-400');
      });

      // Activate clicked tab
      tab.classList.remove('border-transparent', 'text-stone-500', 'dark:text-stone-400');
      tab.classList.add('border-stone-800', 'dark:border-stone-200', 'text-stone-800', 'dark:text-stone-200');

      // Show content
      contents.forEach(c => c.classList.add('hidden'));
      const targetId = tab.getAttribute('data-target');
      if (targetId) {
        document.getElementById(targetId)?.classList.remove('hidden');
      }
    });
  });
</script>