---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ImageViewer from '../../components/ImageViewer.astro';
import { supabase } from '../../lib/supabase';

const { id } = Astro.params;

// 1. Fetch Project
const { data: project } = await supabase
  .from('projects')
  .select(`*, profiles (username, avatar_url, full_name)`)
  .eq('id', id)
  .maybeSingle();

let profile, comments, displayName, isOwner, currentUser;

if (project) {
  // 2. Auth & Ownership Check
  const { data: sessionData } = await supabase.auth.getSession();
  currentUser = sessionData?.session?.user;
  isOwner = currentUser?.id === project.user_id;

  // 3. Fetch Profile
  profile = project.profiles;
  displayName = profile.full_name || profile.username || "Unknown";

  // 4. Fetch Comments
  const { data: commentsData } = await supabase
    .from('comments')
    .select(`*, images, profiles (username, avatar_url, full_name)`)
    .eq('project_id', id)
    .order('created_at', { ascending: false });
    
  comments = commentsData;
}
---

<BaseLayout title={project ? project.title : "Project Not Found"}>

  {project ? (
  <div class="max-w-4xl mx-auto px-6 py-10">
    
    <div class="bg-stone-100 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-2xl overflow-hidden shadow-sm mb-8">
      <div class="aspect-video w-full overflow-hidden bg-stone-200 dark:bg-stone-700 border-b border-stone-200 dark:border-stone-700">
        {project.images && project.images.length > 0 ? (
          <ImageViewer images={project.images} title={project.title} className="h-full" />
        ) : project.image_url ? (
          <ImageViewer images={[project.image_url]} title={project.title} className="h-full" />
        ) : (
          <div class="w-full h-full flex items-center justify-center text-stone-400 text-6xl">üñºÔ∏è</div>
        )}
      </div>

      <div class="p-8">
        <a href={`/profile/${project.user_id}`} class="flex items-center gap-3 mb-6 group w-fit">
          <img src={profile.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${profile.username}`} class="w-12 h-12 rounded-xl bg-stone-200 dark:bg-stone-700 object-cover border border-stone-200 dark:border-stone-700" />
          <div>
            <p class="font-normal text-lg text-stone-800 dark:text-stone-200 group-hover:underline">{displayName}</p>
            <p class="text-sm text-stone-500 dark:text-stone-400">@{profile.username}</p>
          </div>
        </a>

        <h1 class="text-4xl font-normal text-stone-800 dark:text-stone-200 mb-4">{project.title}</h1>
        <p class="text-lg text-stone-600 dark:text-stone-300 leading-relaxed mb-8 font-normal">{project.description}</p>

        <div class="flex items-center justify-between pt-6 border-t border-stone-200 dark:border-stone-700">
          <div class="flex items-center gap-6 text-sm font-normal text-stone-500 dark:text-stone-400">
            <span class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.60L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" /></svg>
              {project.likes || 0}
            </span>
            <span class="flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
              {comments?.length || 0}
            </span>
          </div>
          <div class="flex gap-3">
            <button id="like-btn" class="flex items-center gap-2 px-5 py-2.5 bg-stone-100 dark:bg-stone-800 text-stone-800 dark:text-stone-200 rounded-xl text-sm font-normal hover:bg-stone-200 dark:hover:bg-stone-700 transition-colors">
              üëç Like
            </button>
            <button id="comment-btn-scroll" class="flex items-center gap-2 px-5 py-2.5 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 rounded-xl text-sm font-normal hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
              üí¨ Comment
            </button>
            {isOwner && (
              <button id="delete-project-btn" class="flex items-center gap-2 px-5 py-2.5 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 rounded-xl text-sm font-normal hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors" title="Delete project">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete
              </button>
            )}
          </div>
        </div>
      </div>
    </div>

    <div id="comments-section" class="bg-stone-100 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-2xl p-8 shadow-sm">
      <h3 class="text-xl font-normal text-stone-800 dark:text-stone-200 mb-6">Discussion</h3>

      <div class="mb-10">
        {currentUser ? (
          <form id="comment-form" class="flex gap-4">
            <input type="hidden" id="project_id" value={project.id} />
            <div class="w-10 h-10 rounded-xl bg-stone-200 dark:bg-stone-700 overflow-hidden flex-shrink-0">
               <img src={currentUser.user_metadata?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=user`} class="w-full h-full object-cover" />
            </div>
            <div class="flex-1">
              <textarea 
                id="comment-content" 
                rows="3" 
                class="w-full px-4 py-3 rounded-xl bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-600 text-stone-800 dark:text-stone-200 focus:outline-none focus:ring-2 focus:ring-stone-600 dark:focus:ring-stone-400 resize-none text-sm font-normal" 
                placeholder="What are your thoughts?"
                required
              ></textarea>
              <div class="flex justify-end mt-3">
                <button type="submit" class="px-6 py-2 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 font-normal text-sm rounded-xl hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
                  Post Comment
                </button>
              </div>
            </div>
          </form>
        ) : (
          <div class="bg-stone-50 dark:bg-stone-800/50 rounded-xl p-6 text-center border border-dashed border-stone-200 dark:border-stone-600">
            <p class="text-stone-500 dark:text-stone-400 text-sm mb-3 font-normal">Join the conversation to leave a comment.</p>
            <a href="/login" class="inline-block px-6 py-2 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 font-normal text-sm rounded-xl hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">Log In</a>
          </div>
        )}
      </div>

      <div class="space-y-8">
        {comments && comments.length > 0 ? (
          comments.map((comment) => (
            <div class="flex gap-4 group">
              <a href={`/profile/${comment.user_id}`} class="w-10 h-10 rounded-xl bg-stone-200 dark:bg-stone-700 overflow-hidden flex-shrink-0">
                <img src={comment.profiles.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${comment.profiles.username}`} class="w-full h-full object-cover" />
              </a>
              <div class="flex-1">
                <div class="flex items-center justify-between mb-1">
                  <div class="flex items-center gap-2">
                    <span class="font-normal text-sm text-stone-800 dark:text-stone-200 hover:underline cursor-pointer">
                      {comment.profiles.full_name || comment.profiles.username}
                    </span>
                    <span class="text-xs text-stone-400 dark:text-stone-500">‚Ä¢ {new Date(comment.created_at).toLocaleDateString()}</span>
                  </div>
                  
                  <!-- Delete Button for Comment Owner -->
                  {currentUser?.id === comment.user_id && (
                    <button class="delete-comment-btn text-stone-400 hover:text-red-500 dark:hover:text-red-400 transition-colors p-1 rounded-lg hover:bg-stone-200 dark:hover:bg-stone-700" data-comment-id={comment.id} title="Delete comment">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  )}
                </div>
                <p class="text-stone-600 dark:text-stone-300 text-sm leading-relaxed font-normal">{comment.content}</p>
              </div>
            </div>
          ))
        ) : (
          <p class="text-stone-400 dark:text-stone-500 italic text-center py-4 font-normal">No comments yet.</p>
        )}
      </div>
    </div>
  </div>

  ) : (
    <div class="flex items-center justify-center min-h-[60vh]">
      <div class="text-center">
        <h1 class="text-6xl font-normal text-stone-800 dark:text-stone-200 mb-4">404</h1>
        <p class="text-stone-500 dark:text-stone-400 mb-8 font-normal">Project not found.</p>
        <a href="/explore" class="bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 px-6 py-3 rounded-xl font-normal hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">Back to Explore</a>
      </div>
    </div>
  )}

</BaseLayout>

<script define:vars={{ projectId: id, currentUserId: currentUser?.id }}>
  import { supabase } from '../../lib/supabase';

  // Comment Form Logic
  const commentForm = document.getElementById('comment-form');
  
  if (commentForm) {
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const contentEl = document.getElementById('comment-content') as HTMLTextAreaElement;
      const projectIdEl = document.getElementById('project_id') as HTMLInputElement;
      const content = contentEl.value.trim();
      const projectId = projectIdEl.value;

      // Check Session Client-Side
      const { data: { session } } = await supabase.auth.getSession();
      
      if (!session) {
        alert('You must be logged in to comment.');
        window.location.href = '/login';
        return;
      }

      const { error } = await supabase.from('comments').insert({
        content,
        project_id: projectId,
        user_id: session.user.id
      });

      if (error) {
        alert('Error: ' + error.message);
      } else {
        window.location.reload(); 
      }
    });
  }

  // Scroll to Comment
  const scrollBtn = document.getElementById('comment-btn-scroll');
  if (scrollBtn) {
    scrollBtn.addEventListener('click', () => {
      document.getElementById('comments-section')?.scrollIntoView({ behavior: 'smooth' });
      document.getElementById('comment-content')?.focus();
    });
  }

  // Like Logic
  const likeBtn = document.getElementById('like-btn');
  if (likeBtn) {
    likeBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/project/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ project_id: projectId })
        });
        
        if (response.ok) {
          const result = await response.json();
          likeBtn.textContent = result.liked ? `üëç ${result.likeCount} Liked` : `üëç ${result.likeCount} Like`;
          likeBtn.classList.toggle('bg-red-100', result.liked);
          likeBtn.classList.toggle('text-red-700', result.liked);
          likeBtn.classList.toggle('bg-stone-100', !result.liked);
          likeBtn.classList.toggle('text-stone-800', !result.liked);
        } else {
          const error = await response.text();
          alert('Failed to like project: ' + error);
        }
      } catch (error) {
        console.error('Error liking project:', error);
        alert('Failed to like project');
      }
    });
  }

  // Delete project functionality
  const deleteProjectBtn = document.getElementById('delete-project-btn');
  if (deleteProjectBtn) {
    deleteProjectBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/project/delete`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ project_id: projectId })
        });
        
        if (response.ok) {
          // Redirect to explore page
          window.location.href = '/explore';
        } else {
          const error = await response.text();
          alert('Failed to delete project: ' + error);
        }
      } catch (error) {
        console.error('Error deleting project:', error);
        alert('Failed to delete project');
      }
    });
  }

  // Delete comment functionality
  const deleteCommentBtns = document.querySelectorAll('.delete-comment-btn');
  deleteCommentBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
        return;
      }
      
      const commentId = btn.getAttribute('data-comment-id');
      
      try {
        const response = await fetch(`/api/project/comment/delete`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment_id: commentId })
        });
        
        if (response.ok) {
          window.location.reload();
        } else {
          const error = await response.text();
          alert('Failed to delete comment: ' + error);
        }
      } catch (error) {
        console.error('Error deleting comment:', error);
        alert('Failed to delete comment');
      }
    });
  });
</script>