---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

// Get session from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  const { data } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  currentUser = data.session?.user;
}

let systemStatus = {
  timestamp: new Date().toISOString(),
  authentication: {
    status: !!currentUser,
    user_id: currentUser?.id || null
  },
  database: {
    tables: {},
    functions: {},
    relationships: {}
  },
  imports: {
    supabase: false,
    autoEncryption: false
  },
  messaging: {
    canCreateConversation: false,
    canSendMessage: false,
    canViewInbox: false
  }
};

// Test database tables and functions
if (currentUser) {
  // Test conversations table
  try {
    const { data, error } = await supabase.from('conversations').select('id').limit(1);
    systemStatus.database.tables.conversations = !error;
  } catch (e) {
    systemStatus.database.tables.conversations = false;
  }

  // Test conversation_participants table
  try {
    const { data, error } = await supabase.from('conversation_participants').select('user_id').limit(1);
    systemStatus.database.tables.conversation_participants = !error;
  } catch (e) {
    systemStatus.database.tables.conversation_participants = false;
  }

  // Test messages table
  try {
    const { data, error } = await supabase.from('messages').select('id').limit(1);
    systemStatus.database.tables.messages = !error;
  } catch (e) {
    systemStatus.database.tables.messages = false;
  }

  // Test profiles table
  try {
    const { data, error } = await supabase.from('profiles').select('id').limit(1);
    systemStatus.database.tables.profiles = !error;
  } catch (e) {
    systemStatus.database.tables.profiles = false;
  }

  // Test user_encryption_keys table
  try {
    const { data, error } = await supabase.from('user_encryption_keys').select('user_id').limit(1);
    systemStatus.database.tables.user_encryption_keys = !error;
  } catch (e) {
    systemStatus.database.tables.user_encryption_keys = false;
  }

  // Test foreign key relationship (use fallback approach)
  try {
    const { data: participants, error: participantsError } = await supabase
      .from('conversation_participants')
      .select('user_id')
      .limit(1);
    
    if (participantsError) {
      systemStatus.database.relationships.participants_profiles = false;
    } else if (participants && participants.length > 0) {
      // Try to get profile for the participant
      const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('username')
        .eq('id', participants[0].user_id)
        .single();
      
      systemStatus.database.relationships.participants_profiles = !profileError;
    } else {
      systemStatus.database.relationships.participants_profiles = true; // No data to test, assume OK
    }
  } catch (e) {
    systemStatus.database.relationships.participants_profiles = false;
  }

  // Test unread counts function
  try {
    const { data, error } = await supabase.rpc('get_conversation_unread_counts', {
      p_user_id: currentUser.id
    });
    systemStatus.database.functions.get_conversation_unread_counts = !error;
  } catch (e) {
    systemStatus.database.functions.get_conversation_unread_counts = false;
  }

  // Test messaging functionality
  try {
    // Test if user can view their conversations
    const { data: participations, error: participationsError } = await supabase
      .from('conversation_participants')
      .select('conversation_id')
      .eq('user_id', currentUser.id);
    
    systemStatus.messaging.canViewInbox = !participationsError;
    
    if (participations && participations.length > 0) {
      // Test if user can view conversation details
      const { data: conversations, error: conversationsError } = await supabase
        .from('conversations')
        .select('*')
        .in('id', participations.map(p => p.conversation_id))
        .limit(1);
      
      systemStatus.messaging.canCreateConversation = !conversationsError;
    }
  } catch (e) {
    systemStatus.messaging.canViewInbox = false;
  }
}

// Get some sample data for testing
let sampleData = null;
if (currentUser) {
  try {
    const { data: participations } = await supabase
      .from('conversation_participants')
      .select('conversation_id')
      .eq('user_id', currentUser.id)
      .limit(3);
    
    if (participations && participations.length > 0) {
      const { data: conversations } = await supabase
        .from('conversations')
        .select('*')
        .in('id', participations.map(p => p.conversation_id))
        .limit(3);
      
      sampleData = {
        participations: participations,
        conversations: conversations
      };
    }
  } catch (e) {
    // Ignore errors for sample data
  }
}
---

<BaseLayout title="System Status">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <h1 class="text-3xl font-bold mb-8">System Status Dashboard</h1>
    
    <!-- Authentication Status -->
    <div class="mb-6 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
      <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        <span class={`w-3 h-3 rounded-full ${systemStatus.authentication.status ? 'bg-green-500' : 'bg-red-500'}`}></span>
        Authentication
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <span class="font-medium">Status:</span> 
          <span class={systemStatus.authentication.status ? 'text-green-600' : 'text-red-600'}>
            {systemStatus.authentication.status ? 'Authenticated' : 'Not Authenticated'}
          </span>
        </div>
        <div>
          <span class="font-medium">User ID:</span> 
          <span class="font-mono text-sm">{systemStatus.authentication.user_id || 'None'}</span>
        </div>
      </div>
    </div>

    <!-- Database Status -->
    <div class="mb-6 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
      <h2 class="text-xl font-bold mb-4">Database Status</h2>
      
      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">Tables</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {Object.entries(systemStatus.database.tables).map(([table, status]) => (
            <div class="flex items-center gap-2">
              <span class={`w-2 h-2 rounded-full ${status ? 'bg-green-500' : 'bg-red-500'}`}></span>
              <span class="font-mono text-sm">{table}</span>
            </div>
          ))}
        </div>
      </div>

      <div class="mb-4">
        <h3 class="text-lg font-semibold mb-2">Relationships</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {Object.entries(systemStatus.database.relationships).map(([rel, status]) => (
            <div class="flex items-center gap-2">
              <span class={`w-2 h-2 rounded-full ${status ? 'bg-green-500' : 'bg-red-500'}`}></span>
              <span class="font-mono text-sm">{rel}</span>
            </div>
          ))}
        </div>
      </div>

      <div>
        <h3 class="text-lg font-semibold mb-2">Functions</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {Object.entries(systemStatus.database.functions).map(([func, status]) => (
            <div class="flex items-center gap-2">
              <span class={`w-2 h-2 rounded-full ${status ? 'bg-green-500' : 'bg-red-500'}`}></span>
              <span class="font-mono text-sm">{func}</span>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Messaging Status -->
    <div class="mb-6 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
      <h2 class="text-xl font-bold mb-4">Messaging Status</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {Object.entries(systemStatus.messaging).map(([feature, status]) => (
          <div class="flex items-center gap-2">
            <span class={`w-2 h-2 rounded-full ${status ? 'bg-green-500' : 'bg-red-500'}`}></span>
            <span class="text-sm">{feature.replace(/([A-Z])/g, ' $1').toLowerCase()}</span>
          </div>
        ))}
      </div>
    </div>

    <!-- Import Status -->
    <div class="mb-6 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
      <h2 class="text-xl font-bold mb-4">Dynamic Import Status</h2>
      <div class="space-y-4">
        <div class="flex items-center gap-4">
          <button 
            id="test-supabase-import" 
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          >
            Test Supabase Import
          </button>
          <span id="supabase-import-status" class="text-sm">Not tested</span>
        </div>
        
        <div class="flex items-center gap-4">
          <button 
            id="test-encryption-import" 
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          >
            Test Auto Encryption Import
          </button>
          <span id="encryption-import-status" class="text-sm">Not tested</span>
        </div>
      </div>
    </div>

    <!-- Sample Data -->
    {sampleData && (
      <div class="mb-6 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
        <h2 class="text-xl font-bold mb-4">Sample Data</h2>
        <pre class="bg-neutral-100 dark:bg-neutral-800 p-4 rounded-lg text-sm overflow-auto max-h-64 whitespace-pre-wrap">{JSON.stringify(sampleData, null, 2)}</pre>
      </div>
    )}

    <!-- Quick Actions -->
    <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
      <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
      <div class="space-y-2">
        <a href="/inbox" class="inline-block px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors mr-2">
          Go to Inbox
        </a>
        <a href="/inbox-debug" class="inline-block px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors mr-2">
          Inbox Debug
        </a>
        <a href="/test-imports" class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mr-2">
          Test Imports
        </a>
        <a href="/encryption-status" class="inline-block px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors mr-2">
          Encryption Status
        </a>
        {sampleData?.conversations?.[0] && (
          <a href={`/inbox/${sampleData.conversations[0].id}`} class="inline-block px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors mr-2">
            Test Conversation
          </a>
        )}
      </div>
    </div>

    <!-- Raw System Status -->
    <div class="mt-8 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
      <h2 class="text-xl font-bold mb-4">Raw System Status</h2>
      <pre class="bg-neutral-100 dark:bg-neutral-800 p-4 rounded-lg text-sm overflow-auto max-h-96 whitespace-pre-wrap">{JSON.stringify(systemStatus, null, 2)}</pre>
    </div>
  </div>
</BaseLayout>

<script>
  // Test supabase import
  document.getElementById('test-supabase-import')?.addEventListener('click', async () => {
    const statusEl = document.getElementById('supabase-import-status');
    try {
      const supabaseModule = await import('../lib/supabase.js');
      const supabase = supabaseModule.supabase;
      
      if (statusEl) {
        statusEl.textContent = '✅ Success';
        statusEl.className = 'text-sm text-green-600';
      }
    } catch (error) {
      if (statusEl) {
        statusEl.textContent = '❌ Failed: ' + error.message;
        statusEl.className = 'text-sm text-red-600';
      }
    }
  });

  // Test auto encryption import
  document.getElementById('test-encryption-import')?.addEventListener('click', async () => {
    const statusEl = document.getElementById('encryption-import-status');
    try {
      const autoEncryptionModule = await import('../lib/autoEncryption.js');
      const autoEncryption = autoEncryptionModule.autoEncryption;
      
      if (statusEl) {
        statusEl.textContent = '✅ Success';
        statusEl.className = 'text-sm text-green-600';
      }
    } catch (error) {
      if (statusEl) {
        statusEl.textContent = '❌ Failed: ' + error.message;
        statusEl.className = 'text-sm text-red-600';
      }
    }
  });
</script>
</BaseLayout>