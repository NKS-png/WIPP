---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

// 1. Fetch Services (with Creator Profile)
// We use a Left Join to ensure we get the user details
const { data: services, error } = await supabase
  .from('services')
  .select(`
    *,
    profiles (username, full_name, avatar_url)
  `)
  .order('created_at', { ascending: false });

---

<BaseLayout title="Explore Services">
  
  <div class="relative bg-white dark:bg-neutral-900 border-b border-neutral-100 dark:border-neutral-800">
    <div class="max-w-7xl mx-auto px-6 py-16 md:py-20 text-center animate-fade-in-up">
      <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-neutral-900 dark:text-white mb-4">
        Find the perfect <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">creative service</span>.
      </h1>
      <p class="text-lg text-neutral-500 max-w-2xl mx-auto mb-8">
        Connect with talented creators offering design, development, writing, and more.
      </p>

      <div class="max-w-md mx-auto relative group">
        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-neutral-400 group-focus-within:text-neutral-900 dark:group-focus-within:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        <input 
          type="text" 
          placeholder="Search services (e.g. Logo Design)..." 
          class="block w-full pl-11 pr-4 py-3 rounded-full border border-neutral-200 dark:border-neutral-800 bg-neutral-50 dark:bg-neutral-800 text-neutral-900 dark:text-white placeholder-neutral-400 focus:outline-none focus:ring-2 focus:ring-neutral-900 dark:focus:ring-white focus:bg-white dark:focus:bg-neutral-900 transition-all shadow-sm"
        />
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-6 py-12">
    
    {services && services.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 animate-fade-in-up delay-100">
        {services.map((service) => (
          <div class="group flex flex-col h-full bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl overflow-hidden hover:shadow-xl hover:border-neutral-300 dark:hover:border-neutral-600 transition-all duration-300 transform hover:-translate-y-1">
            
            {/* Card Content */}
            <div class="p-6 flex flex-col flex-1">
              
              {/* Creator Header */}
              <div class="flex items-center justify-between mb-4">
                <a href={`/profile/${service.user_id}`} class="flex items-center gap-2 group/user">
                    <div class="w-8 h-8 rounded-full bg-neutral-100 dark:bg-neutral-800 overflow-hidden border border-neutral-100 dark:border-neutral-700">
                    {service.profiles?.avatar_url ? (
                        <img src={service.profiles.avatar_url} class="w-full h-full object-cover" alt={service.profiles.username} />
                    ) : (
                        <div class="w-full h-full flex items-center justify-center text-xs font-bold text-neutral-500">
                            {service.profiles?.username?.[0]?.toUpperCase() || 'U'}
                        </div>
                    )}
                    </div>
                    <span class="text-xs font-medium text-neutral-500 group-hover/user:text-neutral-900 dark:group-hover/user:text-white transition-colors">
                    @{service.profiles?.username || 'user'}
                    </span>
                </a>

                {/* Price Badge */}
                <span class="px-3 py-1 bg-neutral-100 dark:bg-neutral-800 text-neutral-900 dark:text-white text-xs font-bold rounded-full border border-neutral-200 dark:border-neutral-700">
                    ${service.price}
                </span>
              </div>

              {/* Title */}
              <h3 class="text-lg font-bold text-neutral-900 dark:text-white mb-2 leading-snug group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                {service.title}
              </h3>
              
              {/* Description (Truncated) */}
              <p class="text-sm text-neutral-500 leading-relaxed line-clamp-3 mb-6 flex-1">
                {service.description}
              </p>

              {/* Footer / Action */}
              <div class="pt-4 border-t border-neutral-100 dark:border-neutral-800 mt-auto">
                <button class="w-full py-2.5 rounded-lg bg-neutral-900 dark:bg-white text-white dark:text-black text-sm font-medium hover:opacity-90 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                  <span>View Details</span>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                </button>
              </div>

            </div>
          </div>
        ))}
      </div>
    ) : (
      /* Empty State */
      <div class="flex flex-col items-center justify-center py-24 text-center animate-fade-in-up">
        <div class="w-20 h-20 bg-neutral-50 dark:bg-neutral-800 rounded-full flex items-center justify-center mb-6">
            <svg class="w-8 h-8 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
        </div>
        <h3 class="text-xl font-bold text-neutral-900 dark:text-white mb-2">No services found</h3>
        <p class="text-neutral-500 max-w-md mb-8">
          It looks like no one has posted a service yet. Be the first to offer your skills to the community!
        </p>
        <a href="/profile/me" class="btn-primary px-8 py-3 rounded-full">
          Create a Service
        </a>
      </div>
    )}

  </div>
</BaseLayout>

<style>
  /* Reuse the fade-in animation */
  .animate-fade-in-up {
    animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    opacity: 0;
    transform: translateY(20px);
  }
  .delay-100 { animation-delay: 100ms; }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>