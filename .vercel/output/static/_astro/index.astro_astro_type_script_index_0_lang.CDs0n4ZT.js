const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/supabase.DCKg3lBM.js","_astro/index.C1Qlw3jS.js"])))=>i.map(i=>d[i]);
import{_ as T}from"./preload-helper.BlTxHScW.js";let y=null,R=null;async function V(){try{y=(await T(()=>import("./supabase.DCKg3lBM.js"),__vite__mapDeps([0,1]))).supabase}catch(a){return console.error("Failed to load supabase:",a),!1}try{R=(await T(()=>import("./keyManager.R0xhbMgW.js"),[])).keyManager}catch(a){console.log("Encryption not available:",a.message)}return!0}V().then(a=>{if(!a){console.error("Failed to initialize required modules"),$();return}O()});function $(){console.log("Initializing basic inbox functionality...");const a=document.getElementById("search-input"),r=document.querySelectorAll(".conversation-item");a&&a.addEventListener("input",c=>{const b=c.target.value.toLowerCase();r.forEach(m=>{(m.textContent?.toLowerCase()||"").includes(b)?m.style.display="block":m.style.display="none"})});const f=document.getElementById("new-message-btn"),i=document.getElementById("new-message-modal"),E=document.getElementById("close-modal-btn"),I=document.getElementById("cancel-message-btn");f?.addEventListener("click",()=>{i.classList.remove("hidden")});function u(){i.classList.add("hidden")}E?.addEventListener("click",u),I?.addEventListener("click",u),i?.addEventListener("click",c=>{c.target===i&&u()})}function O(){const a=document.getElementById("search-input"),r=document.querySelectorAll(".conversation-item");a&&a.addEventListener("input",e=>{const t=e.target.value.toLowerCase();r.forEach(n=>{(n.textContent?.toLowerCase()||"").includes(t)?n.style.display="block":n.style.display="none"})});function f(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(800,e.currentTime),t.frequency.setValueAtTime(600,e.currentTime+.1),n.gain.setValueAtTime(0,e.currentTime),n.gain.linearRampToValueAtTime(.1,e.currentTime+.01),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.2),t.start(e.currentTime),t.stop(e.currentTime+.2)}catch(e){console.log("Could not play notification sound:",e)}}r.length;async function i(){try{const e=await fetch("/api/conversation-unread-counts");if(e.ok){const{counts:t}=await e.json();r.forEach(n=>{const o=n.getAttribute("data-conversation-id"),s=n.querySelector(".notification-dot"),l=t[o]||0;l>0?s&&(s.textContent=l>99?"99+":l.toString(),s.classList.remove("hidden")):s&&s.classList.add("hidden")})}}catch(e){console.log("Error updating unread counts:",e)}}async function E(){try{const{data:{session:e}}=await y.auth.getSession();if(!e)return;const{data:t}=await y.from("conversation_participants").select("conversation_id").eq("user_id",e.user.id);if(!t)return;const n=t.map(s=>s.conversation_id),{data:o}=await y.from("messages").select("conversation_id, sender_id, created_at").in("conversation_id",n).neq("sender_id",e.user.id).gte("created_at",new Date(Date.now()-3e4).toISOString()).order("created_at",{ascending:!1});if(o&&o.length>0){const s=localStorage.getItem("lastInboxCheck"),l=Date.now();(!s||l-parseInt(s)>3e4)&&f(),localStorage.setItem("lastInboxCheck",l.toString()),i(),setTimeout(()=>{document.visibilityState==="visible"&&window.location.reload()},5e3)}}catch(e){console.log("Error checking for new messages:",e)}}setInterval(i,1e4),setInterval(E,15e3),y.channel("inbox_updates").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},e=>{console.log("New message received:",e),f(),I(),i(),setTimeout(()=>{document.visibilityState==="visible"&&window.location.reload()},3e3)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reads"},e=>{console.log("Message read status updated:",e),i()}).subscribe();function I(){window.showNotification&&window.showNotification("New message received!","success",3e3)}console.log("Inbox loaded with",r.length,"conversations");const u=document.getElementById("new-message-btn"),c=document.getElementById("new-message-modal"),b=document.getElementById("close-modal-btn"),m=document.getElementById("cancel-message-btn"),d=document.getElementById("user-search-input"),p=document.getElementById("user-search-results"),L=document.getElementById("user-search-loading"),g=document.getElementById("user-search-empty"),x=document.getElementById("user-search-list"),_=document.getElementById("selected-user"),S=document.getElementById("selected-user-avatar"),k=document.getElementById("selected-user-name"),C=document.getElementById("selected-user-username"),N=document.getElementById("remove-selected-user"),w=document.getElementById("message-input"),h=document.getElementById("send-message-btn");let v=null,M;u?.addEventListener("click",()=>{c.classList.remove("hidden"),d.focus()});function B(){c.classList.add("hidden"),A()}b?.addEventListener("click",B),m?.addEventListener("click",B);function A(){d.value="",w.value="",v=null,_.classList.add("hidden"),p.classList.add("hidden"),x.innerHTML=""}d?.addEventListener("input",e=>{const t=e.target.value.trim();if(clearTimeout(M),t.length<2){p.classList.add("hidden");return}M=setTimeout(()=>{q(t)},300)});async function q(e){p.classList.remove("hidden"),L.classList.remove("hidden"),g.classList.add("hidden"),x.innerHTML="";try{const n=await(await fetch(`/api/search-users?q=${encodeURIComponent(e)}`)).json();L.classList.add("hidden"),n.users&&n.users.length>0?(g.classList.add("hidden"),n.users.forEach(o=>{const s=document.createElement("button");s.type="button",s.className="w-full flex items-center gap-3 px-4 py-3 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors text-left",s.innerHTML=`
            <img src="${o.avatar}" alt="${o.displayName}" class="w-8 h-8 rounded-full object-cover" />
            <div class="flex-1 min-w-0">
              <div class="font-medium text-neutral-900 dark:text-white truncate">${o.displayName}</div>
              <div class="text-xs text-neutral-500 truncate">@${o.username}</div>
            </div>
          `,s.addEventListener("click",()=>{U(o)}),x.appendChild(s)})):g.classList.remove("hidden")}catch(t){console.error("User search error:",t),L.classList.add("hidden"),g.classList.remove("hidden"),g.textContent="Search failed. Please try again."}}function U(e){v=e.id,S.src=e.avatar,k.textContent=e.displayName,C.textContent=`@${e.username}`,_.classList.remove("hidden"),p.classList.add("hidden"),d.value="",w.focus()}N?.addEventListener("click",()=>{v=null,_.classList.add("hidden"),d.focus()}),h?.addEventListener("click",async()=>{if(!v||!w.value.trim()){alert("Please select a user and enter a message.");return}h.disabled=!0,h.textContent="Sending...";try{const e=await fetch("/api/create-conversation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target_user_id:v,initial_message:w.value.trim()})}),t=await e.json();if(e.ok)window.location.href=`/inbox/${t.conversation_id}`;else throw new Error(t.error||"Failed to create conversation")}catch(e){console.error("Error creating conversation:",e),alert("Failed to send message: "+e.message),h.disabled=!1,h.textContent="Send Message"}}),c?.addEventListener("click",e=>{e.target===c&&B()})}
