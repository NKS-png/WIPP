---
import BaseLayout from '../layouts/BaseLayout.astro';

// Get session from cookies (server-side auth)
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  const { supabase } = await import('../lib/supabase');
  const { data } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  currentUser = data.session?.user;
}

// Redirect if not logged in
if (!currentUser) {
  return Astro.redirect('/login');
}
---

<BaseLayout title="Finding Your Conversation">
  <div class="min-h-screen bg-white dark:bg-neutral-900 flex items-center justify-center px-4">
    <div class="max-w-md w-full text-center">
      <div class="w-20 h-20 bg-blue-100 dark:bg-blue-900/20 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg class="w-10 h-10 text-blue-600 dark:text-blue-400 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
      </div>
      
      <h1 class="text-2xl font-bold text-neutral-900 dark:text-white mb-3">
        Finding Your Conversation
      </h1>
      
      <p class="text-neutral-600 dark:text-neutral-400 mb-6">
        Looking for conversations you can access...
      </p>
      
      <div id="status" class="text-sm text-neutral-500 mb-4">
        Checking conversations...
      </div>
      
      <div class="space-y-3">
        <a 
          href="/inbox" 
          class="block w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-medium hover:shadow-lg transition-all"
        >
          Back to Inbox
        </a>
        
        <a 
          href="/clean-slate-test" 
          class="block w-full px-4 py-3 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 transition-colors"
        >
          Fix Conversations
        </a>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  async function findConversation() {
    const statusEl = document.getElementById('status');
    
    try {
      statusEl.textContent = 'Getting your conversations...';
      
      const response = await fetch('/api/get-my-conversation');
      const data = await response.json();
      
      if (data.success && data.recommended_conversation) {
        statusEl.textContent = 'Found conversation! Redirecting...';
        setTimeout(() => {
          window.location.href = `/inbox/${data.recommended_conversation}`;
        }, 1000);
      } else if (data.success && data.conversations_with_messages === 0) {
        statusEl.innerHTML = 'No conversations with messages found.<br>Please create a conversation first.';
      } else {
        statusEl.textContent = 'Error: ' + (data.error || 'Unknown error');
        console.error('Conversation lookup failed:', data);
      }
    } catch (error) {
      statusEl.textContent = 'Error: ' + error.message;
      console.error('Error finding conversation:', error);
    }
  }
  
  // Start looking for conversation
  findConversation();
</script>
</BaseLayout>