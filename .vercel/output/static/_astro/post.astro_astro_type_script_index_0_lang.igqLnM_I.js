import{supabase as l}from"./supabase.DCKg3lBM.js";import"./index.C1Qlw3jS.js";const $=document.getElementById("auth-loading"),M=document.getElementById("post-content"),f=document.getElementById("error-msg");let o=null;async function k(){const{data:{session:t},error:e}=await l.auth.getSession();e||!t?setTimeout(()=>window.location.href="/login?message=Please log in first",500):(o=t.user,$?.classList.add("hidden"),M?.classList.remove("hidden"))}k();const P=document.getElementById("upload-form"),L=document.getElementById("file-input"),v=document.getElementById("submit-btn"),h=document.getElementById("btn-text"),w=document.getElementById("btn-spinner"),y=document.getElementById("upload-placeholder"),x=document.getElementById("file-previews"),E=document.getElementById("preview-grid"),j=document.getElementById("add-more-files");let s=[];j.addEventListener("click",()=>{L.click()});L.addEventListener("change",t=>{const e=t.target;if(e.files&&e.files.length>0){const i=Array.from(e.files);for(const n of i){if(n.size>10*1024*1024){alert(`File "${n.name}" is too large. Max 10MB per file.`);continue}s.find(d=>d.name===n.name&&d.size===n.size)||s.push(n)}B(),e.value=""}});function B(){if(s.length===0){y.classList.remove("hidden"),x.classList.add("hidden");return}y.classList.add("hidden"),x.classList.remove("hidden"),E.innerHTML="",s.forEach((t,e)=>{const i=document.createElement("div");i.className="relative group bg-neutral-100 dark:bg-neutral-700 rounded-lg overflow-hidden aspect-square";const n=URL.createObjectURL(t);t.type.startsWith("video/")?i.innerHTML=`
          <video src="${n}" class="w-full h-full object-cover" muted></video>
          <div class="absolute inset-0 bg-black/20 flex items-center justify-center">
            <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </div>
          <button type="button" onclick="removeFile(${e})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity">×</button>
          <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs p-1 truncate">${t.name}</div>
        `:i.innerHTML=`
          <img src="${n}" class="w-full h-full object-cover" />
          <button type="button" onclick="removeFile(${e})" class="absolute top-1 right-1 w-6 h-6 bg-red-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity">×</button>
          <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs p-1 truncate">${t.name}</div>
        `,E.appendChild(i)})}window.removeFile=t=>{s.splice(t,1),B()};P.addEventListener("submit",async t=>{if(t.preventDefault(),!!o){v.disabled=!0,h.innerText="Publishing...",w.classList.remove("hidden"),f.classList.add("hidden");try{if(s.length===0)throw new Error("Please select at least one file to upload.");const e=document.getElementById("title").value,i=document.getElementById("description").value,n=document.getElementById("category").value,{data:d}=await l.from("profiles").select("username").eq("id",o.id).single();let a=d?.username;if(!a){const r=(o.user_metadata?.full_name||o.email?.split("@")[0]||"user").toLowerCase().replace(/[^a-z0-9]/g,""),c=Math.floor(Math.random()*9999)+1;a=`${r}${c}`;let u=0;for(;u<10;){const{data:m}=await l.from("profiles").select("id").eq("username",a).single();if(!m)break;const g=Math.floor(Math.random()*9999)+1;a=`${r}${g}`,u++}}await l.from("profiles").upsert({id:o.id,email:o.email,username:a,full_name:o.user_metadata?.full_name||null,updated_at:new Date().toISOString()},{onConflict:"id"});const p=[];for(let r=0;r<s.length;r++){const c=s[r],u=c.name.split(".").pop(),m=`${o.id}/${Date.now()}_${r}.${u}`;h.innerText=`Uploading ${r+1}/${s.length}...`;const{error:g}=await l.storage.from("projects").upload(m,c);if(g)throw g;const{data:{publicUrl:I}}=l.storage.from("projects").getPublicUrl(m);p.push(I)}const{error:b}=await l.from("projects").insert({title:e,description:i,category:n,image_url:p[0],images:p,user_id:o.id});if(b)throw b;window.location.href="/explore"}catch(e){console.error(e),f.innerText=e.message||"Error posting project",f.classList.remove("hidden"),v.disabled=!1,h.innerText="Publish Project",w.classList.add("hidden")}}});
