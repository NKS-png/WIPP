---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

// Server-side auth check
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  const { data } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  currentUser = data.session?.user;
}

// Test community queries
let testResults = {
  communities: null,
  communityError: null,
  posts: null,
  postsError: null,
  memberCount: null,
  memberError: null
};

try {
  // Test communities query
  const { data: communities, error: communitiesError } = await supabase
    .from('communities')
    .select('*')
    .limit(5);
  
  testResults.communities = communities;
  testResults.communityError = communitiesError;
  
  if (communities && communities.length > 0) {
    const firstCommunity = communities[0];
    
    // Test posts query for first community
    try {
      const { data: posts, error: postsError } = await supabase
        .from('posts')
        .select(`*, profiles (username, full_name, avatar_url)`)
        .eq('community_id', firstCommunity.id)
        .limit(3);
      
      testResults.posts = posts;
      testResults.postsError = postsError;
    } catch (err) {
      testResults.postsError = err;
      
      // Try fallback
      const { data: posts } = await supabase
        .from('posts')
        .select('*')
        .eq('community_id', firstCommunity.id)
        .limit(3);
      
      testResults.posts = posts;
    }
    
    // Test member count
    try {
      const { count, error: memberError } = await supabase
        .from('community_members')
        .select('*', { count: 'exact', head: true })
        .eq('community_id', firstCommunity.id);
      
      testResults.memberCount = count;
      testResults.memberError = memberError;
    } catch (err) {
      testResults.memberError = err;
    }
  }
} catch (err) {
  testResults.communityError = err;
}
---

<BaseLayout title="Community System Test">
  <div class="max-w-4xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-8 dark:text-white">Community System Test</h1>
    
    <div class="space-y-8">
      
      <!-- Auth Status -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">Authentication Status</h2>
        <div class="space-y-2">
          <p class="dark:text-neutral-300">
            <strong>User:</strong> {currentUser ? `${currentUser.email} (${currentUser.id})` : 'Not logged in'}
          </p>
          <p class="dark:text-neutral-300">
            <strong>Access Token:</strong> {accessToken ? 'Present' : 'Missing'}
          </p>
          <p class="dark:text-neutral-300">
            <strong>Refresh Token:</strong> {refreshToken ? 'Present' : 'Missing'}
          </p>
        </div>
      </div>

      <!-- Communities Query Test -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">Communities Query Test</h2>
        <div class="space-y-4">
          {testResults.communityError ? (
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg">
              <p class="text-red-600 dark:text-red-400 font-medium">Error:</p>
              <pre class="text-sm text-red-500 dark:text-red-300 mt-2">{JSON.stringify(testResults.communityError, null, 2)}</pre>
            </div>
          ) : (
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 p-4 rounded-lg">
              <p class="text-green-600 dark:text-green-400 font-medium">Success: Found {testResults.communities?.length || 0} communities</p>
              {testResults.communities && testResults.communities.length > 0 && (
                <div class="mt-4 space-y-2">
                  {testResults.communities.map((community) => (
                    <div class="bg-white dark:bg-neutral-800 p-3 rounded border">
                      <p class="font-medium dark:text-white">{community.name}</p>
                      <p class="text-sm text-neutral-500 dark:text-neutral-400">ID: {community.id}</p>
                      <p class="text-sm text-neutral-500 dark:text-neutral-400">Admin: {community.admin_id}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      <!-- Posts Query Test -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">Posts Query Test</h2>
        <div class="space-y-4">
          {testResults.postsError ? (
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg">
              <p class="text-red-600 dark:text-red-400 font-medium">Error:</p>
              <pre class="text-sm text-red-500 dark:text-red-300 mt-2">{JSON.stringify(testResults.postsError, null, 2)}</pre>
            </div>
          ) : (
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 p-4 rounded-lg">
              <p class="text-green-600 dark:text-green-400 font-medium">Success: Found {testResults.posts?.length || 0} posts</p>
              {testResults.posts && testResults.posts.length > 0 && (
                <div class="mt-4 space-y-2">
                  {testResults.posts.map((post) => (
                    <div class="bg-white dark:bg-neutral-800 p-3 rounded border">
                      <p class="font-medium dark:text-white">{post.content?.substring(0, 100)}...</p>
                      <p class="text-sm text-neutral-500 dark:text-neutral-400">Type: {post.type}</p>
                      <p class="text-sm text-neutral-500 dark:text-neutral-400">User: {post.profiles?.username || post.user_id}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      <!-- Member Count Test -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">Member Count Test</h2>
        <div class="space-y-4">
          {testResults.memberError ? (
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg">
              <p class="text-red-600 dark:text-red-400 font-medium">Error:</p>
              <pre class="text-sm text-red-500 dark:text-red-300 mt-2">{JSON.stringify(testResults.memberError, null, 2)}</pre>
            </div>
          ) : (
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 p-4 rounded-lg">
              <p class="text-green-600 dark:text-green-400 font-medium">Success: Member count = {testResults.memberCount}</p>
            </div>
          )}
        </div>
      </div>

      <!-- API Test Buttons -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">API Test Buttons</h2>
        <div class="space-y-4">
          <div class="flex gap-4 flex-wrap">
            <button id="test-join" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              Test Join Community
            </button>
            <button id="test-leave" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
              Test Leave Community
            </button>
            <button id="test-post" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
              Test Create Post
            </button>
            <button id="test-update" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
              Test Update Community
            </button>
          </div>
          <div id="api-results" class="mt-4 p-4 bg-neutral-50 dark:bg-neutral-800 rounded-lg hidden">
            <h3 class="font-medium mb-2 dark:text-white">API Test Results:</h3>
            <pre id="api-output" class="text-sm text-neutral-600 dark:text-neutral-300"></pre>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="text-center space-x-4">
        <a href="/communities" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
          → Go to Communities
        </a>
        <a href="/communities/create" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300">
          → Create Community
        </a>
      </div>

    </div>
  </div>
</BaseLayout>

<script define:vars={{ testCommunityId: testResults.communities?.[0]?.id }}>
  const apiResults = document.getElementById('api-results');
  const apiOutput = document.getElementById('api-output');

  function showResult(result) {
    apiResults.classList.remove('hidden');
    apiOutput.textContent = JSON.stringify(result, null, 2);
  }

  // Test Join Community
  document.getElementById('test-join').addEventListener('click', async () => {
    if (!testCommunityId) {
      showResult({ error: 'No test community available' });
      return;
    }

    try {
      const response = await fetch('/api/community/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ community_id: testCommunityId })
      });
      
      const result = {
        status: response.status,
        statusText: response.statusText,
        body: await response.text()
      };
      
      showResult(result);
    } catch (error) {
      showResult({ error: error.message });
    }
  });

  // Test Leave Community
  document.getElementById('test-leave').addEventListener('click', async () => {
    if (!testCommunityId) {
      showResult({ error: 'No test community available' });
      return;
    }

    try {
      const response = await fetch('/api/community/leave', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ community_id: testCommunityId })
      });
      
      const result = {
        status: response.status,
        statusText: response.statusText,
        body: await response.text()
      };
      
      showResult(result);
    } catch (error) {
      showResult({ error: error.message });
    }
  });

  // Test Create Post
  document.getElementById('test-post').addEventListener('click', async () => {
    if (!testCommunityId) {
      showResult({ error: 'No test community available' });
      return;
    }

    try {
      const formData = new FormData();
      formData.append('community_id', testCommunityId);
      formData.append('content', 'Test post from community test page');
      formData.append('type', 'portfolio');

      const response = await fetch('/api/community/post', {
        method: 'POST',
        body: formData
      });
      
      const result = {
        status: response.status,
        statusText: response.statusText,
        body: await response.text()
      };
      
      showResult(result);
    } catch (error) {
      showResult({ error: error.message });
    }
  });

  // Test Update Community
  document.getElementById('test-update').addEventListener('click', async () => {
    if (!testCommunityId) {
      showResult({ error: 'No test community available' });
      return;
    }

    try {
      const response = await fetch('/api/community/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          community_id: testCommunityId,
          name: 'Updated Test Community',
          description: 'Updated description from test page'
        })
      });
      
      const result = {
        status: response.status,
        statusText: response.statusText,
        body: await response.text()
      };
      
      showResult(result);
    } catch (error) {
      showResult({ error: error.message });
    }
  });
</script>