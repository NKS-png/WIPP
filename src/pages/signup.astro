---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Sign Up">
  <div class="max-w-md mx-auto py-12">
    <h1 class="text-2xl font-bold mb-2 text-center animate-fade-in-up">Create Account</h1>
    <p class="text-neutral-500 text-center text-sm mb-8 animate-fade-in-up delay-75">Join the community today</p>

    <form id="signup-form" class="space-y-5 animate-fade-in-up delay-100">
      
      <div class="flex justify-center mb-6">
        <div class="relative group cursor-pointer">
          <input type="file" id="avatar-upload" accept="image/*" class="hidden" />
          
          <div 
            id="avatar-preview" 
            class="w-24 h-24 rounded-full bg-neutral-100 dark:bg-neutral-800 border-2 border-dashed border-neutral-300 dark:border-neutral-700 flex items-center justify-center overflow-hidden transition-all group-hover:border-neutral-900 dark:group-hover:border-white relative"
          >
            <svg id="avatar-icon" class="w-8 h-8 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <img id="avatar-img" class="w-full h-full object-cover hidden" />
            
            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-white text-xs font-bold">Upload</span>
            </div>
          </div>
          <p class="text-center text-xs text-neutral-500 mt-2">Tap to add photo</p>
        </div>
      </div>

      <div class="group">
        <label class="block text-xs font-bold uppercase text-neutral-500 mb-2 transition-colors group-focus-within:text-neutral-900 dark:group-focus-within:text-white">Display Name</label>
        <input type="text" id="full-name" class="input-field w-full transition-all duration-200 focus:scale-[1.01]" required placeholder="John Doe" />
      </div>

      <div class="group">
        <label class="block text-xs font-bold uppercase text-neutral-500 mb-2 transition-colors group-focus-within:text-neutral-900 dark:group-focus-within:text-white">Email</label>
        <input type="email" id="email" class="input-field w-full transition-all duration-200 focus:scale-[1.01]" required placeholder="name@example.com" />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div class="group">
          <label class="block text-xs font-bold uppercase text-neutral-500 mb-2 transition-colors group-focus-within:text-neutral-900 dark:group-focus-within:text-white">Password</label>
          <input type="password" id="password" class="input-field w-full transition-all duration-200 focus:scale-[1.01]" required placeholder="••••••" />
        </div>
        <div class="group">
          <label class="block text-xs font-bold uppercase text-neutral-500 mb-2 transition-colors group-focus-within:text-neutral-900 dark:group-focus-within:text-white">Confirm</label>
          <input type="password" id="confirm-password" class="input-field w-full transition-all duration-200 focus:scale-[1.01]" required placeholder="••••••" />
        </div>
      </div>

      <div class="pt-4">
        <button 
          type="submit" 
          id="submitBtn"
          class="btn-primary w-full relative overflow-hidden transition-all duration-150 active:scale-95 flex items-center justify-center gap-2 h-12"
        >
          <span id="btnText" class="font-medium">Create Account</span>
          <svg id="btnSpinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>
      </div>

      <div id="statusMessage" class="hidden text-sm text-center py-2 rounded-lg mt-4"></div>

      <p class="text-sm text-center text-neutral-500">
        Already have an account? <a href="/login" class="text-neutral-900 dark:text-white font-medium hover:underline">Log in</a>
      </p>
    </form>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../lib/supabase';

  // --- AUDIO SETUP ---
  const clickAudio = new Audio("https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3");
  clickAudio.volume = 0.5;

  // --- DOM ELEMENTS ---
  const form = document.getElementById('signup-form') as HTMLFormElement;
  const avatarInput = document.getElementById('avatar-upload') as HTMLInputElement;
  const avatarPreview = document.getElementById('avatar-preview');
  const avatarImg = document.getElementById('avatar-img') as HTMLImageElement;
  const avatarIcon = document.getElementById('avatar-icon');
  
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const btnText = document.getElementById('btnText');
  const btnSpinner = document.getElementById('btnSpinner');
  const statusMessage = document.getElementById('statusMessage');

  let selectedFile: File | null = null;

  // --- 1. IMAGE PREVIEW ---
  avatarPreview?.addEventListener('click', () => avatarInput.click());

  avatarInput.addEventListener('change', (e) => {
    const target = e.target as HTMLInputElement;
    if (target.files && target.files[0]) {
      selectedFile = target.files[0];
      const reader = new FileReader();
      reader.onload = (e) => {
        if (e.target?.result) {
            avatarImg.src = e.target.result as string;
            avatarImg.classList.remove('hidden');
            avatarIcon?.classList.add('hidden');
            clickAudio.currentTime = 0;
            clickAudio.play().catch(() => {});
        }
      };
      reader.readAsDataURL(selectedFile);
    }
  });

  // --- 2. SUBMIT LOGIC ---
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    clickAudio.play().catch(() => {});

    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;
    const confirmPassword = (document.getElementById('confirm-password') as HTMLInputElement).value;
    const fullName = (document.getElementById('full-name') as HTMLInputElement).value;

    statusMessage!.className = "hidden text-sm text-center py-2 rounded-lg mt-4";
    
    if (password !== confirmPassword) {
      showMessage("Passwords do not match", "error");
      return;
    }

    setLoading(true);

    try {
      // A. SIGN UP (Auth Only)
      const { data: authData, error: authError } = await supabase.auth.signUp({ 
        email, 
        password,
        options: { data: { full_name: fullName } }
      });

      if (authError) throw authError;
      if (!authData.user) throw new Error("No user returned");

      // B. *** CRITICAL FIX: FORCE CREATE PROFILE ***
      // We manually upsert the profile to ensure the database row exists.
      // This prevents "Foreign Key" errors later.
      const { error: profileError } = await supabase
        .from('profiles')
        .upsert({
            id: authData.user.id,
            email: email,
            full_name: fullName,
            updated_at: new Date().toISOString()
        }, { onConflict: 'id' });

      if (profileError) {
          console.warn("Manual profile creation warning:", profileError);
          // Proceed anyway, as it might have been created by a trigger
      }

      // C. HANDLE AVATAR UPLOAD (Now safe because profile exists)
      if (selectedFile) {
         try {
             const fileExt = selectedFile.name.split('.').pop();
             const fileName = `${authData.user.id}/avatar.${fileExt}`;
             
             const { error: uploadError } = await supabase.storage
                .from('avatars')
                .upload(fileName, selectedFile);

             if (!uploadError) {
                 const { data: urlData } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(fileName);
                 
                 // Update the profile we just ensured exists
                 await supabase
                    .from('profiles')
                    .update({ avatar_url: urlData.publicUrl })
                    .eq('id', authData.user.id);
             }
         } catch (uploadErr) {
             console.warn("Avatar upload skipped:", uploadErr);
         }
      }

      // D. SUCCESS
      showMessage("Account created! Redirecting...", "success");
      setTimeout(() => window.location.href = '/login?message=Account created', 1500);

    } catch (error: any) {
      showMessage(error.message || "Something went wrong", "error");
      setLoading(false);
    }
  });

  // --- HELPERS ---
  function setLoading(isLoading: boolean) {
    if (isLoading) {
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-80', 'cursor-not-allowed');
        btnText!.textContent = "Creating Account...";
        btnSpinner!.classList.remove('hidden');
    } else {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-80', 'cursor-not-allowed');
        btnText!.textContent = "Create Account";
        btnSpinner!.classList.add('hidden');
    }
  }

  function showMessage(msg: string, type: 'success' | 'error') {
    statusMessage!.textContent = msg;
    statusMessage!.classList.remove('hidden');
    if (type === 'error') {
        statusMessage!.classList.add('bg-red-50', 'text-red-500', 'border', 'border-red-100', 'animate-shake');
        statusMessage!.classList.remove('bg-green-50', 'text-green-500');
    } else {
        statusMessage!.classList.add('bg-green-50', 'text-green-500', 'border', 'border-green-100');
        statusMessage!.classList.remove('bg-red-50', 'text-red-500', 'animate-shake');
    }
  }
</script>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
  }
  .delay-75 { animation-delay: 75ms; }
  .delay-100 { animation-delay: 100ms; }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
    20%, 40%, 60%, 80% { transform: translateX(4px); }
  }
  .animate-shake {
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
  }
</style>