---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase';

// Server-side auth check (Protects the page)
const { data: { session } } = await supabase.auth.getSession();
if (!session) {
  return Astro.redirect('/login');
}
---

<BaseLayout title="Create Community">
  <div class="min-h-[80vh] flex items-center justify-center px-6">
    <div class="w-full max-w-lg">
      
      <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-neutral-900 dark:text-white mb-3">Create a Community</h1>
        <p class="text-neutral-500">Build a space for like-minded artists to gather.</p>
      </div>
      
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-3xl p-8 shadow-xl">
        <form id="create-community-form" class="space-y-6">
          
          <div>
            <label class="block text-xs font-bold uppercase text-neutral-500 mb-2 ml-1">Community Name</label>
            <input 
              type="text" 
              id="name" 
              class="w-full px-5 py-4 rounded-xl bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white transition-all font-medium placeholder-neutral-400" 
              placeholder="e.g. Minimalist Photography" 
              required 
            />
          </div>
          
          <div>
            <label class="block text-xs font-bold uppercase text-neutral-500 mb-2 ml-1">Description</label>
            <textarea 
              id="description" 
              class="w-full px-5 py-4 rounded-xl bg-neutral-50 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-black dark:focus:ring-white transition-all font-medium placeholder-neutral-400 resize-none" 
              rows="4" 
              placeholder="What is this group about?"
              required
            ></textarea>
          </div>

          <div class="pt-2">
            <button 
              type="submit" 
              id="submit-btn" 
              class="w-full py-4 rounded-xl bg-neutral-900 dark:bg-white text-white dark:text-black font-bold text-lg hover:scale-[1.02] active:scale-[0.98] transition-all shadow-lg flex items-center justify-center gap-2"
            >
              <span>ðŸš€ Launch Community</span>
            </button>
          </div>

          <p id="error-msg" class="text-red-500 text-sm hidden text-center bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border border-red-200 dark:border-red-800"></p>
        </form>
      </div>

      <div class="text-center mt-8">
        <a href="/communities" class="text-sm font-bold text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors">Cancel</a>
      </div>

    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../../lib/supabase';
  
  const form = document.getElementById('create-community-form');
  const errorMsg = document.getElementById('error-msg');
  const submitBtn = document.getElementById('submit-btn');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // 1. UI Loading State
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="animate-spin">âŸ³</span> Creating...';
      submitBtn.setAttribute('disabled', 'true');
      submitBtn.classList.add('opacity-70');
      errorMsg.classList.add('hidden');

      const name = (document.getElementById('name') as HTMLInputElement).value;
      const desc = (document.getElementById('description') as HTMLTextAreaElement).value;
      
      // 2. Get User
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
          window.location.href = '/login';
          return;
      }
      const user = session.user;

      try {
        // 3. Create Community (FIX: using 'admin_id' instead of 'creator_id')
        const { data: community, error: createError } = await supabase
          .from('communities')
          .insert({ 
            name, 
            description: desc, 
            admin_id: user.id // <--- The Fix
          })
          .select()
          .single();

        if (createError) throw createError;

        // 4. Auto-join Creator as Admin
        const { error: joinError } = await supabase.from('community_members').insert({
            community_id: community.id,
            user_id: user.id,
            role: 'admin'
        });

        if (joinError) throw joinError;

        // 5. Success Redirect (FIX: Route is /communities/ID)
        window.location.href = `/communities/${community.id}`;

      } catch (err: any) {
        // Handle Errors
        console.error(err);
        errorMsg.innerText = err.message || "Something went wrong.";
        errorMsg.classList.remove('hidden');
        
        // Reset Button
        submitBtn.innerHTML = originalBtnText;
        submitBtn.removeAttribute('disabled');
        submitBtn.classList.remove('opacity-70');
      }
    });
  }
</script>