---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

// Get session from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  const { data } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  currentUser = data.session?.user;
}

let debugInfo = {
  authenticated: !!currentUser,
  user_id: currentUser?.id || null,
  timestamp: new Date().toISOString()
};

if (currentUser) {
  // Test basic queries
  try {
    // Test 1: Get user's conversation participations
    const { data: participations, error: participationsError } = await supabase
      .from('conversation_participants')
      .select('conversation_id')
      .eq('user_id', currentUser.id);
    
    debugInfo.participations = {
      success: !participationsError,
      count: participations?.length || 0,
      data: participations?.slice(0, 5) || [],
      error: participationsError?.message
    };

    // Test 2: Get conversations
    if (participations && participations.length > 0) {
      const conversationIds = participations.map(p => p.conversation_id);
      
      const { data: conversations, error: conversationsError } = await supabase
        .from('conversations')
        .select('*')
        .in('id', conversationIds)
        .order('updated_at', { ascending: false });
      
      debugInfo.conversations = {
        success: !conversationsError,
        count: conversations?.length || 0,
        data: conversations?.slice(0, 5) || [],
        error: conversationsError?.message
      };

      // Test 3: Get messages
      const { data: messages, error: messagesError } = await supabase
        .from('messages')
        .select('*')
        .in('conversation_id', conversationIds)
        .order('created_at', { ascending: false })
        .limit(10);
      
      debugInfo.messages = {
        success: !messagesError,
        count: messages?.length || 0,
        data: messages?.slice(0, 5) || [],
        error: messagesError?.message
      };

      // Test 4: Try the complex query that was failing
      try {
        const { data: complexQuery, error: complexError } = await supabase
          .from('conversation_participants')
          .select(`
            conversation_id,
            conversations!inner(*)
          `)
          .eq('user_id', currentUser.id);
        
        debugInfo.complex_query = {
          success: !complexError,
          count: complexQuery?.length || 0,
          data: complexQuery?.slice(0, 3) || [],
          error: complexError?.message
        };
      } catch (e) {
        debugInfo.complex_query = {
          success: false,
          error: e.message
        };
      }

      // Test 5: Try profile join that was failing
      try {
        const { data: profileJoin, error: profileError } = await supabase
          .from('conversation_participants')
          .select(`
            user_id,
            profiles(username, full_name, avatar_url)
          `)
          .eq('conversation_id', conversationIds[0]);
        
        debugInfo.profile_join = {
          success: !profileError,
          count: profileJoin?.length || 0,
          data: profileJoin?.slice(0, 3) || [],
          error: profileError?.message
        };
      } catch (e) {
        debugInfo.profile_join = {
          success: false,
          error: e.message
        };
      }
    }
  } catch (error) {
    debugInfo.general_error = error.message;
  }
}
---

<BaseLayout title="Inbox Debug">
  <div class="max-w-6xl mx-auto py-8 px-4">
    <div class="mb-6">
      <a href="/inbox" class="text-blue-600 hover:text-blue-800">← Back to Inbox</a>
    </div>
    
    <h1 class="text-3xl font-bold mb-8">Inbox Debug Information</h1>
    
    <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
      <h2 class="text-xl font-bold mb-4">Debug Results</h2>
      <pre class="bg-neutral-100 dark:bg-neutral-800 p-4 rounded-lg text-sm overflow-auto max-h-96 whitespace-pre-wrap">{JSON.stringify(debugInfo, null, 2)}</pre>
    </div>

    <div class="mt-8 space-y-4">
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
        <h2 class="text-xl font-bold mb-4">Test Dynamic Imports</h2>
        
        <div class="space-y-4">
          <div>
            <button 
              id="test-supabase-import" 
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mr-4"
            >
              Test Supabase Import
            </button>
            <span id="supabase-status" class="text-sm text-gray-600"></span>
          </div>
          
          <div>
            <button 
              id="test-encryption-import" 
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors mr-4"
            >
              Test Auto Encryption Import
            </button>
            <span id="encryption-status" class="text-sm text-gray-600"></span>
          </div>
        </div>
      </div>

      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6">
        <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
        
        <div class="space-y-2">
          <a href="/simple-chat?id={debugInfo.participations?.data?.[0]?.conversation_id}" class="inline-block px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors mr-2">
            Test Simple Chat
          </a>
          <a href="/test-imports" class="inline-block px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors mr-2">
            Test Imports Page
          </a>
          <a href="/encryption-status" class="inline-block px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            Check Database Status
          </a>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Test supabase import
  document.getElementById('test-supabase-import')?.addEventListener('click', async () => {
    const statusEl = document.getElementById('supabase-status');
    try {
      const supabaseModule = await import('../lib/supabase.js');
      const supabase = supabaseModule.supabase;
      
      if (statusEl) {
        statusEl.textContent = '✅ Supabase imported successfully';
        statusEl.className = 'text-sm text-green-600';
      }
    } catch (error) {
      if (statusEl) {
        statusEl.textContent = '❌ Failed: ' + error.message;
        statusEl.className = 'text-sm text-red-600';
      }
    }
  });

  // Test auto encryption import
  document.getElementById('test-encryption-import')?.addEventListener('click', async () => {
    const statusEl = document.getElementById('encryption-status');
    try {
      const autoEncryptionModule = await import('../lib/autoEncryption.js');
      const autoEncryption = autoEncryptionModule.autoEncryption;
      
      if (statusEl) {
        statusEl.textContent = '✅ Auto encryption imported successfully';
        statusEl.className = 'text-sm text-green-600';
      }
    } catch (error) {
      if (statusEl) {
        statusEl.textContent = '❌ Failed: ' + error.message;
        statusEl.className = 'text-sm text-red-600';
      }
    }
  });
</script>
</BaseLayout>