---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ImageViewer from '../../components/ImageViewer.astro';
import { supabase } from '../../lib/supabase';

const { id } = Astro.params;

console.log('Post detail page - ID:', id);

// Get current user
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  try {
    const { data } = await supabase.auth.setSession({
      access_token: accessToken,
      refresh_token: refreshToken,
    });
    currentUser = data.session?.user;
    console.log('Current user:', currentUser?.id);
  } catch (error) {
    console.error('Auth error:', error);
  }
}

// Fetch post with author and community info
let post = null;
let community = null;
let author = null;

try {
  console.log('Fetching post with ID:', id);
  
  // First try without joins to see if post exists
  const { data: basicPost, error: basicError } = await supabase
    .from('posts')
    .select('*')
    .eq('id', id)
    .maybeSingle();

  console.log('Basic post query result:', { basicPost, basicError });

  if (basicPost) {
    // Now try with joins
    const { data: postData, error } = await supabase
      .from('posts')
      .select(`
        *,
        profiles (id, username, full_name, avatar_url),
        communities (id, name, image_url)
      `)
      .eq('id', id)
      .maybeSingle();

    console.log('Post with joins query result:', { postData, error });

    if (postData) {
      post = postData;
      author = postData.profiles;
      community = postData.communities;
    } else if (error) {
      console.error('Error fetching post with joins:', error);
      // Fallback to basic post data
      post = basicPost;
      
      // Try to fetch author and community separately
      if (basicPost.user_id) {
        const { data: authorData } = await supabase
          .from('profiles')
          .select('id, username, full_name, avatar_url')
          .eq('id', basicPost.user_id)
          .single();
        author = authorData;
      }
      
      if (basicPost.community_id) {
        const { data: communityData } = await supabase
          .from('communities')
          .select('id, name, image_url')
          .eq('id', basicPost.community_id)
          .single();
        community = communityData;
      }
    }
  }
} catch (error) {
  console.error('Error fetching post:', error);
}

console.log('Final post data:', { post: !!post, author: !!author, community: !!community });

if (!post) {
  // Post not found - will show 404-style message
}

// Fetch comments/replies for this post
let comments = [];
try {
  const { data: commentsData } = await supabase
    .from('post_comments')
    .select(`
      *,
      profiles (id, username, full_name, avatar_url)
    `)
    .eq('post_id', id)
    .order('created_at', { ascending: true });
  
  // Organize comments into a nested structure
  const commentsMap = new Map();
  const topLevelComments = [];
  
  // First pass: create all comment objects
  commentsData?.forEach(comment => {
    commentsMap.set(comment.id, { ...comment, replies: [] });
  });
  
  // Second pass: organize into hierarchy
  commentsData?.forEach(comment => {
    if (comment.parent_id) {
      // This is a reply
      const parent = commentsMap.get(comment.parent_id);
      if (parent) {
        parent.replies.push(commentsMap.get(comment.id));
      }
    } else {
      // This is a top-level comment
      topLevelComments.push(commentsMap.get(comment.id));
    }
  });
  
  comments = topLevelComments;
} catch (error) {
  console.error('Error fetching comments:', error);
}
---

<BaseLayout title={`Post in c/${community?.name || 'Community'}`}>
  
  {!post ? (
    <!-- Post Not Found Section -->
    <div class="max-w-4xl mx-auto px-6 py-8">
      <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-2xl p-6 mb-8">
        <h1 class="text-2xl font-normal text-red-800 dark:text-red-200 mb-4">Post Not Found</h1>
        <div class="space-y-4 text-sm">
          <div>
            <strong>Post ID:</strong> {id}
          </div>
          <div>
            <strong>URL:</strong> {Astro.url.pathname}
          </div>
          <div class="bg-red-100 dark:bg-red-900/30 p-4 rounded-lg">
            <p class="text-red-700 dark:text-red-300">
              The post with ID "{id}" could not be found in the database. This could mean:
            </p>
            <ul class="list-disc list-inside mt-2 text-red-600 dark:text-red-400">
              <li>The post doesn't exist</li>
              <li>There's a database connection issue</li>
              <li>The post ID format is incorrect</li>
              <li>There are foreign key relationship issues</li>
            </ul>
          </div>
          <div class="flex gap-4 mt-6">
            <a href="/communities" class="bg-stone-600 text-white px-4 py-2 rounded hover:bg-stone-700">
              Back to Communities
            </a>
          </div>
        </div>
      </div>
    </div>
  ) : (
    <>
      <!-- Breadcrumb -->
      <div class="max-w-4xl mx-auto px-6 py-4 border-b border-stone-200 dark:border-stone-700">
    <div class="flex items-center gap-2 text-sm text-stone-500 dark:text-stone-400 font-normal">
      <a href="/communities" class="hover:text-stone-800 dark:hover:text-stone-200 transition-colors">Communities</a>
      <span>›</span>
      <a href={`/c/${community?.id}`} class="hover:text-stone-800 dark:hover:text-stone-200 transition-colors">c/{community?.name}</a>
      <span>›</span>
      <span class="text-stone-800 dark:text-stone-200">Post</span>
    </div>
  </div>

  <div class="max-w-4xl mx-auto px-6 py-8">
    
    <!-- Original Post -->
    <div class="bg-stone-100 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-2xl p-6 mb-8">
      
      <!-- Post Header -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <a href={`/profile/${author?.id}`} class="w-12 h-12 rounded-xl bg-stone-200 dark:bg-stone-700 overflow-hidden">
            <img src={author?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${author?.username || 'user'}`} class="w-full h-full object-cover" />
          </a>
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <a href={`/profile/${author?.id}`} class="font-normal text-stone-800 dark:text-stone-200 hover:underline">{author?.full_name || author?.username}</a>
              <span class="text-stone-400 dark:text-stone-500">•</span>
              <span class="text-sm text-stone-500 dark:text-stone-400 font-normal">{new Date(post.created_at).toLocaleDateString()}</span>
            </div>
            <div class="flex items-center gap-2 text-sm text-stone-500 dark:text-stone-400 font-normal">
              <a href={`/c/${community?.id}`} class="hover:text-stone-700 dark:hover:text-stone-300 transition-colors">c/{community?.name}</a>
              {post.type === 'workshop' && (
                <>
                  <span>•</span>
                  <span class="px-2 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 rounded-xl text-xs font-normal">Workshop</span>
                </>
              )}
            </div>
          </div>
        </div>
        
        <!-- Delete Button for Post Owner -->
        {currentUser?.id === post.user_id && (
          <button id="delete-post-btn" class="text-stone-400 hover:text-red-500 dark:hover:text-red-400 transition-colors p-2 rounded-xl hover:bg-stone-200 dark:hover:bg-stone-700" title="Delete post">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </button>
        )}
      </div>

      <!-- Post Content -->
      <div class="mb-4">
        <p class="text-stone-800 dark:text-stone-200 text-lg leading-relaxed whitespace-pre-wrap font-normal">{post.content}</p>
        
        {(post.image_urls && post.image_urls.length > 0) ? (
          <div class="mt-4">
            <ImageViewer images={post.image_urls} title={`Post by ${author?.full_name || author?.username}`} />
          </div>
        ) : post.image_url ? (
          <div class="mt-4">
            <ImageViewer images={[post.image_url]} title={`Post by ${author?.full_name || author?.username}`} />
          </div>
        ) : null}
        
        {post.type === 'workshop' && post.work_stage && (
          <div class="mt-4 p-4 bg-stone-50 dark:bg-stone-800 rounded-xl">
            <div class="text-sm text-stone-600 dark:text-stone-400 font-normal">
              <strong>Stage:</strong> {post.work_stage}
              {post.feedback_goals && post.feedback_goals.length > 0 && (
                <>
                  <br />
                  <strong>Feedback wanted:</strong> {post.feedback_goals.join(', ')}
                </>
              )}
            </div>
          </div>
        )}
      </div>

      <!-- Post Actions -->
      <div class="flex items-center gap-4 pt-4 border-t border-stone-200 dark:border-stone-700">
        <button class="flex items-center gap-2 text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <span class="text-sm font-normal">{comments.length} {comments.length === 1 ? 'Reply' : 'Replies'}</span>
        </button>
        
        <button class="flex items-center gap-2 text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 transition-colors" id="like-post-btn">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
          <span class="text-sm font-normal" id="like-count">Like</span>
        </button>
        
        <button class="flex items-center gap-2 text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
          </svg>
          <span class="text-sm font-normal">Share</span>
        </button>
      </div>
    </div>

    <!-- Comment Form -->
    {currentUser ? (
      <div class="bg-stone-100 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-2xl p-6 mb-8">
        <form id="comment-form" class="space-y-4">
          <div class="flex gap-3">
            <div class="w-10 h-10 rounded-xl bg-stone-200 dark:bg-stone-700 overflow-hidden flex-shrink-0">
              <img src={currentUser.user_metadata?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${currentUser.email || 'user'}`} class="w-full h-full object-cover" />
            </div>
            <div class="flex-1">
              <textarea 
                id="comment-content" 
                rows="3" 
                class="w-full bg-stone-50 dark:bg-stone-900 rounded-xl p-3 outline-none resize-none text-stone-800 dark:text-stone-200 border border-stone-200 dark:border-stone-600 focus:border-stone-400 dark:focus:border-stone-400 transition-colors font-normal" 
                placeholder="Add a thoughtful reply..."
                required
              ></textarea>
              <div class="flex justify-end mt-3">
                <button type="submit" class="px-6 py-2 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 rounded-xl font-normal text-sm hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
                  Reply
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    ) : (
      <div class="bg-stone-50 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-2xl p-6 mb-8 text-center">
        <p class="text-stone-600 dark:text-stone-400 mb-4 font-normal">Join the conversation</p>
        <a href="/login" class="inline-block px-6 py-2 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 rounded-xl font-normal text-sm hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
          Log in to reply
        </a>
      </div>
    )}

    <!-- Comments -->
    <div class="space-y-4">
      {comments.length > 0 ? (
        comments.map(comment => (
          <div class="comment-thread">
            <!-- Top-level comment -->
            <div class="bg-stone-100 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-2xl p-6">
              <div class="flex items-start gap-3">
                <a href={`/profile/${comment.profiles?.id}`} class="w-10 h-10 rounded-xl bg-stone-200 dark:bg-stone-700 overflow-hidden flex-shrink-0">
                  <img src={comment.profiles?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${comment.profiles?.username || 'user'}`} class="w-full h-full object-cover" />
                </a>
                <div class="flex-1">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <a href={`/profile/${comment.profiles?.id}`} class="font-normal text-stone-800 dark:text-stone-200 hover:underline text-sm">{comment.profiles?.full_name || comment.profiles?.username}</a>
                      <span class="text-xs text-stone-500 dark:text-stone-400">{new Date(comment.created_at).toLocaleDateString()}</span>
                    </div>
                    
                    <!-- Delete Button for Comment Owner -->
                    {currentUser?.id === comment.user_id && (
                      <button class="delete-comment-btn text-stone-400 hover:text-red-500 dark:hover:text-red-400 transition-colors p-1 rounded-lg hover:bg-stone-200 dark:hover:bg-stone-700" data-comment-id={comment.id} title="Delete comment">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    )}
                  </div>
                  <p class="text-stone-700 dark:text-stone-300 leading-relaxed whitespace-pre-wrap font-normal">{comment.content}</p>
                  
                  <div class="flex items-center gap-4 mt-3">
                    <button class="flex items-center gap-1 text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 transition-colors text-sm font-normal">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                      </svg>
                      Like
                    </button>
                    {currentUser && (
                      <button class="reply-btn text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 transition-colors text-sm font-normal" data-comment-id={comment.id}>
                        Reply
                      </button>
                    )}
                  </div>
                  
                  <!-- Reply Form (initially hidden) -->
                  {currentUser && (
                    <div class="reply-form mt-4 hidden" data-comment-id={comment.id}>
                      <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-xl bg-stone-200 dark:bg-stone-700 overflow-hidden flex-shrink-0">
                          <img src={currentUser.user_metadata?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${currentUser.email || 'user'}`} class="w-full h-full object-cover" />
                        </div>
                        <div class="flex-1">
                          <textarea 
                            class="reply-content w-full bg-stone-50 dark:bg-stone-900 rounded-xl p-3 outline-none resize-none text-stone-800 dark:text-stone-200 border border-stone-200 dark:border-stone-600 focus:border-stone-400 dark:focus:border-stone-400 transition-colors font-normal text-sm" 
                            rows="2"
                            placeholder="Write a reply..."
                            required
                          ></textarea>
                          <div class="flex justify-end gap-2 mt-2">
                            <button type="button" class="cancel-reply-btn px-3 py-1 text-stone-500 hover:text-stone-700 dark:hover:text-stone-300 text-sm font-normal">
                              Cancel
                            </button>
                            <button type="button" class="submit-reply-btn px-4 py-1 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 rounded-xl font-normal text-sm hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
                              Reply
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
            
            <!-- Nested Replies -->
            {comment.replies && comment.replies.length > 0 && (
              <div class="ml-8 mt-4 space-y-4">
                {comment.replies.map(reply => (
                  <div class="bg-stone-50 dark:bg-stone-900 border border-stone-200 dark:border-stone-700 rounded-xl p-4">
                    <div class="flex items-start gap-3">
                      <a href={`/profile/${reply.profiles?.id}`} class="w-8 h-8 rounded-xl bg-stone-200 dark:bg-stone-700 overflow-hidden flex-shrink-0">
                        <img src={reply.profiles?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${reply.profiles?.username || 'user'}`} class="w-full h-full object-cover" />
                      </a>
                      <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                          <div class="flex items-center gap-2">
                            <a href={`/profile/${reply.profiles?.id}`} class="font-normal text-stone-800 dark:text-stone-200 hover:underline text-sm">{reply.profiles?.full_name || reply.profiles?.username}</a>
                            <span class="text-xs text-stone-500 dark:text-stone-400">{new Date(reply.created_at).toLocaleDateString()}</span>
                          </div>
                          
                          <!-- Delete Button for Reply Owner -->
                          {currentUser?.id === reply.user_id && (
                            <button class="delete-comment-btn text-stone-400 hover:text-red-500 dark:hover:text-red-400 transition-colors p-1 rounded-lg hover:bg-stone-200 dark:hover:bg-stone-700" data-comment-id={reply.id} title="Delete reply">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                              </svg>
                            </button>
                          )}
                        </div>
                        <p class="text-stone-700 dark:text-stone-300 leading-relaxed whitespace-pre-wrap font-normal text-sm">{reply.content}</p>
                        
                        <div class="flex items-center gap-4 mt-2">
                          <button class="flex items-center gap-1 text-stone-500 dark:text-stone-400 hover:text-stone-700 dark:hover:text-stone-300 transition-colors text-xs font-normal">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                            Like
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        ))
      ) : (
        <div class="text-center py-12 text-stone-500 dark:text-stone-400">
          <svg class="w-12 h-12 mx-auto mb-4 text-stone-300 dark:text-stone-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <p class="font-normal">No replies yet. Be the first to comment!</p>
        </div>
      )}
    </div>

  </div>
  </>
  )}
</BaseLayout>

<script define:vars={{ postId: id, currentUserId: currentUser?.id }}>
  // Comment form submission
  const commentForm = document.getElementById('comment-form');
  if (commentForm) {
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const content = document.getElementById('comment-content').value.trim();
      if (!content) return;
      
      try {
        const response = await fetch('/api/post/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            post_id: postId,
            content: content
          })
        });
        
        if (response.ok) {
          window.location.reload();
        } else {
          const error = await response.text();
          alert('Failed to post comment: ' + error);
        }
      } catch (error) {
        console.error('Error posting comment:', error);
        alert('Failed to post comment');
      }
    });
  }

  // Delete post functionality
  const deletePostBtn = document.getElementById('delete-post-btn');
  if (deletePostBtn) {
    deletePostBtn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/post/delete`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ post_id: postId })
        });
        
        if (response.ok) {
          // Redirect to community page
          window.location.href = `/c/${response.headers.get('community-id') || ''}`;
        } else {
          const error = await response.text();
          alert('Failed to delete post: ' + error);
        }
      } catch (error) {
        console.error('Error deleting post:', error);
        alert('Failed to delete post');
      }
    });
  }

  // Delete comment functionality
  const deleteCommentBtns = document.querySelectorAll('.delete-comment-btn');
  deleteCommentBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
        return;
      }
      
      const commentId = btn.getAttribute('data-comment-id');
      
      try {
        const response = await fetch(`/api/post/comment/delete`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment_id: commentId })
        });
        
        if (response.ok) {
          window.location.reload();
        } else {
          const error = await response.text();
          alert('Failed to delete comment: ' + error);
        }
      } catch (error) {
        console.error('Error deleting comment:', error);
        alert('Failed to delete comment');
      }
    });
  });

  // Like post functionality
  const likePostBtn = document.getElementById('like-post-btn');
  if (likePostBtn) {
    likePostBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/post/like', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ post_id: postId })
        });
        
        if (response.ok) {
          const result = await response.json();
          const likeCount = document.getElementById('like-count');
          if (likeCount) {
            likeCount.textContent = result.liked ? `${result.likeCount} Liked` : `${result.likeCount} Like`;
            likePostBtn.classList.toggle('text-red-500', result.liked);
            likePostBtn.classList.toggle('text-stone-500', !result.liked);
          }
        } else {
          const error = await response.text();
          alert('Failed to like post: ' + error);
        }
      } catch (error) {
        console.error('Error liking post:', error);
        alert('Failed to like post');
      }
    });
  }

  // Reply functionality for nested comments
  const replyBtns = document.querySelectorAll('.reply-btn');
  const replyForms = document.querySelectorAll('.reply-form');
  const cancelReplyBtns = document.querySelectorAll('.cancel-reply-btn');
  const submitReplyBtns = document.querySelectorAll('.submit-reply-btn');

  // Show reply form
  replyBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const commentId = btn.getAttribute('data-comment-id');
      const replyForm = document.querySelector(`.reply-form[data-comment-id="${commentId}"]`);
      
      // Hide all other reply forms
      replyForms.forEach(form => {
        if (form !== replyForm) {
          form.classList.add('hidden');
        }
      });
      
      // Toggle this reply form
      if (replyForm) {
        replyForm.classList.toggle('hidden');
        if (!replyForm.classList.contains('hidden')) {
          const textarea = replyForm.querySelector('.reply-content');
          textarea?.focus();
        }
      }
    });
  });

  // Cancel reply
  cancelReplyBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const replyForm = btn.closest('.reply-form');
      if (replyForm) {
        replyForm.classList.add('hidden');
        const textarea = replyForm.querySelector('.reply-content');
        if (textarea) textarea.value = '';
      }
    });
  });

  // Submit reply
  submitReplyBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const replyForm = btn.closest('.reply-form');
      const commentId = replyForm?.getAttribute('data-comment-id');
      const textarea = replyForm?.querySelector('.reply-content');
      const content = textarea?.value.trim();
      
      if (!content || !commentId) return;
      
      try {
        btn.disabled = true;
        btn.textContent = 'Posting...';
        
        const response = await fetch('/api/post/comment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            post_id: postId,
            content: content,
            parent_id: commentId
          })
        });
        
        if (response.ok) {
          window.location.reload();
        } else {
          const error = await response.text();
          alert('Failed to post reply: ' + error);
        }
      } catch (error) {
        console.error('Error posting reply:', error);
        alert('Failed to post reply');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Reply';
      }
    });
  });

  // Handle Enter key in reply textareas
  document.querySelectorAll('.reply-content').forEach(textarea => {
    textarea.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        const submitBtn = textarea.closest('.reply-form')?.querySelector('.submit-reply-btn');
        submitBtn?.click();
      }
    });
  });
</script>
</BaseLayout>