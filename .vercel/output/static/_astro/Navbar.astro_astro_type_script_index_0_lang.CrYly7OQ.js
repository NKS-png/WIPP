import{_ as E}from"./preload-helper.BlTxHScW.js";import{supabase as l}from"./supabase.DCKg3lBM.js";import"./index.C1Qlw3jS.js";const I=window.location.hostname==="localhost";function y(e){const n=`; ${document.cookie}`.split(`; ${e}=`);if(n.length===2)return n.pop().split(";").shift()}const h=y("sb-access-token"),p=y("sb-refresh-token");h&&p&&l.auth.setSession({access_token:h,refresh_token:p});l.auth.onAuthStateChange((e,t)=>{if(e==="SIGNED_IN"&&t){const n=I?"path=/; max-age=31536000; SameSite=Lax":"path=/; max-age=31536000; SameSite=Lax; Secure";document.cookie=`sb-access-token=${t.access_token}; ${n}`,document.cookie=`sb-refresh-token=${t.refresh_token}; ${n}`,document.cookie.includes("sb-access-token")?sessionStorage.removeItem("auth_retry"):sessionStorage.getItem("auth_retry")||(sessionStorage.setItem("auth_retry","true"),window.location.reload())}else e==="SIGNED_OUT"&&(document.cookie="sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie.includes("sb-access-token")?sessionStorage.getItem("signout_retry")||(sessionStorage.setItem("signout_retry","true"),window.location.reload()):sessionStorage.removeItem("signout_retry"))});const S=document.getElementById("mobile-menu-btn"),T=document.getElementById("close-mobile-menu"),r=document.getElementById("mobile-menu"),v=document.body;function _(){r&&(r.setAttribute("data-state","open"),v.style.overflow="hidden")}function w(){r&&(r.setAttribute("data-state","closed"),v.style.overflow="")}S?.addEventListener("click",_);T?.addEventListener("click",w);const x=r?.querySelectorAll("a");x?.forEach(e=>{e.addEventListener("click",w)});async function d(){try{const e=await fetch("/api/unread-count");if(e.ok){const{count:t}=await e.json(),n=document.getElementById("unread-badge"),s=document.getElementById("mobile-unread-badge");if(t&&t>0){const o=t>99?"99+":t.toString();n&&(n.textContent=o,n.classList.remove("hidden")),s&&(s.textContent=o,s.classList.remove("hidden"));const m=parseInt(localStorage.getItem("lastUnreadCount")||"0");t>m&&(k(),!window.location.pathname.includes("/inbox")&&window.showNotification&&window.showNotification(`You have ${t} unread message${t>1?"s":""}`,"info",4e3)),localStorage.setItem("lastUnreadCount",t.toString())}else n&&n.classList.add("hidden"),s&&s.classList.add("hidden"),localStorage.setItem("lastUnreadCount","0")}}catch(e){console.log("Error updating unread count:",e)}}const a=document.getElementById("navbar-search"),i=document.getElementById("search-results"),u=document.getElementById("search-loading"),c=document.getElementById("search-empty"),g=document.getElementById("search-list");let f;a&&(a.addEventListener("input",e=>{const t=e.target.value.trim();if(clearTimeout(f),t.length<2){i.classList.add("hidden");return}f=setTimeout(()=>{B(t)},300)}),a.addEventListener("focus",()=>{a.value.trim().length>=2&&i.classList.remove("hidden")}),document.addEventListener("click",e=>{!a.contains(e.target)&&!i.contains(e.target)&&i.classList.add("hidden")}));async function B(e){if(a){i.classList.remove("hidden"),u.classList.remove("hidden"),c.classList.add("hidden"),g.innerHTML="";try{const n=await(await fetch(`/api/search-users?q=${encodeURIComponent(e)}`)).json();u.classList.add("hidden"),n.users&&n.users.length>0?(c.classList.add("hidden"),n.users.forEach(s=>{const o=document.createElement("a");o.href=`/profile/${s.id}`,o.className="flex items-center gap-3 px-4 py-3 hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors",o.innerHTML=`
            <img src="${s.avatar}" alt="${s.displayName}" class="w-8 h-8 rounded-full object-cover" />
            <div class="flex-1 min-w-0">
              <div class="font-medium text-neutral-900 dark:text-white truncate">${s.displayName}</div>
              <div class="text-xs text-neutral-500 truncate">@${s.username}</div>
            </div>
          `,o.addEventListener("click",()=>{i.classList.add("hidden"),a.value=""}),g.appendChild(o)})):c.classList.remove("hidden")}catch(t){console.error("Search error:",t),u.classList.add("hidden"),c.classList.remove("hidden"),c.textContent="Search failed. Please try again."}}}function k(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(800,e.currentTime),t.frequency.setValueAtTime(600,e.currentTime+.1),n.gain.setValueAtTime(0,e.currentTime),n.gain.linearRampToValueAtTime(.1,e.currentTime+.01),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.2),t.start(e.currentTime),t.stop(e.currentTime+.2)}catch(e){console.log("Could not play notification sound:",e)}}window.playNotificationSound=k;window.updateNavbarUnreadCount=d;async function L(){try{const{data:{session:e}}=await l.auth.getSession();if(!e)return;const{keyManager:t}=await E(async()=>{const{keyManager:b}=await import("./keyManager.R0xhbMgW.js");return{keyManager:b}},[]),n=document.getElementById("encryption-locked"),s=document.getElementById("encryption-unlocked"),o=document.getElementById("encryption-none");await t.hasEncryptionKeys(e.user.id)?t.isUnlocked?(n?.classList.add("hidden"),o?.classList.add("hidden"),s?.classList.remove("hidden")):(s?.classList.add("hidden"),o?.classList.add("hidden"),n?.classList.remove("hidden")):(n?.classList.add("hidden"),s?.classList.add("hidden"),o?.classList.remove("hidden"))}catch(e){console.error("Error updating encryption status:",e)}}document.getElementById("unlock-keys-navbar")?.addEventListener("click",e=>{e.preventDefault(),window.showUnlockKeys&&window.showUnlockKeys()});document.getElementById("setup-encryption-navbar")?.addEventListener("click",e=>{e.preventDefault(),window.showEncryptionSetup&&window.showEncryptionSetup()});L();setInterval(L,5e3);d();setInterval(d,1e4);l.channel("navbar_unread").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},()=>{setTimeout(d,1e3)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reads"},()=>{setTimeout(d,500)}).subscribe();
