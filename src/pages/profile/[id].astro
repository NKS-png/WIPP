---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import MessageButton from '../../components/MessageButton.astro';
import { supabase } from '../../lib/supabase';

// 1. FORCE NO-CACHE (The Fix)
Astro.response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');

const { id } = Astro.params;

// 1. Get Current User (To check if you are the owner)
const { data: sessionData } = await supabase.auth.getSession();
const currentUser = sessionData?.session?.user;
const isOwner = currentUser?.id === id;

// 2. Fetch Profile (Safe Mode)
const { data: profile, error: profileError } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', id)
  .maybeSingle();

// Handle missing profile
if (profileError || !profile) return Astro.redirect('/404');

// 3. Fetch Projects
const { data: projects } = await supabase
  .from('projects')
  .select('*')
  .eq('user_id', id)
  .order('created_at', { ascending: false });

// 4. Fetch Services
const { data: services } = await supabase
  .from('services')
  .select('*')
  .eq('user_id', id);

// 5. Fetch Discussions
const { data: discussions } = await supabase
  .from('discussions')
  .select('*')
  .eq('profile_id', id)
  .order('created_at', { ascending: false });

const displayName = profile.full_name || profile.username || "Unknown";
const initial = displayName.charAt(0).toUpperCase();

console.log('Profile ID:', id);
console.log('Current User:', currentUser);
console.log('isOwner:', isOwner);
---

<BaseLayout title={displayName}>
  
  <div class="relative bg-white dark:bg-neutral-900 border-b border-neutral-200 dark:border-neutral-800">

    <div class="relative group h-64 w-full bg-neutral-100 dark:bg-neutral-800 overflow-hidden">

      {profile.banner_url ? (
        <img
          src={profile.banner_url}
          class="w-full h-full object-cover"
          alt="Profile Banner"
        />
      ) : (
        <div class="w-full h-full bg-gradient-to-r from-neutral-200 to-neutral-300 dark:from-neutral-800 dark:to-neutral-900"></div>
      )}

      {isOwner && (
        <a href="/settings" class="absolute top-4 right-4 bg-black/60 hover:bg-black/80 text-white text-xs font-bold px-4 py-2 rounded-full cursor-pointer transition-all backdrop-blur-md opacity-0 group-hover:opacity-100 translate-y-2 group-hover:translate-y-0">
          ðŸ“· Edit Cover
        </a>
      )}
    </div>

    <div class="max-w-7xl mx-auto px-6">
      <div class="flex flex-col md:flex-row items-start gap-6 -mt-16 pb-8">
        
        <div class="relative group">
          <div class="w-32 h-32 rounded-full border-4 border-white dark:border-neutral-950 bg-white dark:bg-neutral-900 overflow-hidden flex items-center justify-center text-4xl font-bold shadow-sm">
             {profile.avatar_url ? (
               <img src={profile.avatar_url} class="w-full h-full object-cover" alt="Profile" />
             ) : (
               <span class="text-neutral-400">{initial}</span>
             )}
          </div>
          
          {/* Edit Avatar Button (Only visible to Owner) */}
          {isOwner && (
  <a 
    href="/settings" 
    class="border border-neutral-300 dark:border-neutral-600 px-6 py-2 rounded-full text-sm font-bold hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors"
  >
    Edit Profile
  </a>
)}
        </div>

        <div class="flex-1 pt-16 md:pt-0 mt-2">
           <div class="flex justify-between items-start">
              <div>
                <h1 class="text-2xl font-bold text-neutral-900 dark:text-white">{displayName}</h1>
                <p class="text-neutral-500">@{profile.username || 'user'}</p>
                <p class="mt-2 text-neutral-600 dark:text-neutral-400 max-w-lg">{profile.bio || "No bio yet."}</p>
              </div>
              
              <div class="flex gap-3">
                 {isOwner ? (
                   <a href="/settings" class="px-4 py-2 text-sm font-medium border border-neutral-300 dark:border-neutral-700 rounded-full hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors text-neutral-900 dark:text-white">
                     Edit Profile
                   </a>
                 ) : currentUser ? (
                   <>
                     <button class="px-6 py-2 text-sm font-medium bg-neutral-900 dark:bg-white text-white dark:text-black rounded-full hover:opacity-90 transition-opacity">
                       Follow
                     </button>
                     <MessageButton userId={id} username={profile.username || 'user'} variant="secondary" size="sm" />
                   </>
                 ) : null}
              </div>
           </div>
        </div>
      </div>

      {!isOwner && currentUser && (
        <div class="flex justify-center mb-6">
          <MessageButton userId={id} username={profile.username || 'user'} variant="primary" size="lg" />
        </div>
      )}

      <div class="flex gap-8 border-b border-neutral-200 dark:border-neutral-800 text-sm font-medium">
        <button class="tab-btn active-tab pb-4 border-b-2 border-black dark:border-white text-black dark:text-white" data-target="tab-portfolio">
          Portfolio <span class="ml-1 text-neutral-400 text-xs">{projects?.length || 0}</span>
        </button>
        <button class="tab-btn pb-4 border-b-2 border-transparent text-neutral-500 hover:text-neutral-900 dark:hover:text-white transition-colors" data-target="tab-services">
          Services
        </button>
        <button class="tab-btn pb-4 border-b-2 border-transparent text-neutral-500 hover:text-neutral-900 dark:hover:text-white transition-colors" data-target="tab-discussion">
          Discussions
        </button>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-6 py-12 min-h-[500px]">
    
    <div id="tab-portfolio" class="tab-content">
      {projects && projects.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {projects.map((p) => <ProjectCard project={p} />)}
        </div>
      ) : (
        <div class="text-center py-20 bg-neutral-50 dark:bg-neutral-800/50 rounded-2xl border border-dashed border-neutral-200 dark:border-neutral-700">
          <p class="text-neutral-500">No projects uploaded yet.</p>
        </div>
      )}
    </div>

    <div id="tab-services" class="tab-content hidden">
      <div class="text-center py-20">
        <div class="w-16 h-16 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">ðŸ’¼</div>
        <h3 class="text-lg font-bold mb-1 text-neutral-900 dark:text-white">Services</h3>
        <p class="text-neutral-500 mb-6">This user hasn't listed any services yet.</p>
        {isOwner && <button id="add-service-btn" class="btn-primary text-sm px-6 py-2 bg-neutral-900 dark:bg-white text-white dark:text-black rounded-full">Add a Service</button>}
      </div>
    </div>

    <div id="tab-discussion" class="tab-content hidden">
       <div class="text-center py-20">
        <div class="w-16 h-16 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">ðŸ’¬</div>
        <h3 class="text-lg font-bold mb-1 text-neutral-900 dark:text-white">Discussions</h3>
        <p class="text-neutral-500">Start a conversation.</p>
      </div>
    </div>

  </div>

 <div id="service-modal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 px-4 backdrop-blur-sm">
   <div class="bg-white dark:bg-neutral-900 p-6 rounded-2xl w-full max-w-md shadow-2xl animate-fade-in-up">
     <h2 class="text-xl font-bold mb-4">Create Service</h2>
     <form id="service-form" class="space-y-4">
       <div>
         <label class="block text-xs font-bold uppercase text-neutral-500 mb-1">Title</label>
         <input type="text" id="svc-title" class="input-field w-full" placeholder="e.g. Logo Design" required />
       </div>
       <div>
         <label class="block text-xs font-bold uppercase text-neutral-500 mb-1">Price ($)</label>
         <input type="number" id="svc-price" class="input-field w-full" placeholder="50" required />
       </div>
       <div>
         <label class="block text-xs font-bold uppercase text-neutral-500 mb-1">Description</label>
         <textarea id="svc-desc" rows="3" class="input-field w-full" placeholder="What will you deliver?" required></textarea>
       </div>
       <div class="flex gap-3 pt-2">
         <button type="button" id="close-svc-modal" class="flex-1 py-2.5 rounded-lg border border-neutral-200 dark:border-neutral-700 font-bold">Cancel</button>
         <button type="submit" class="flex-1 py-2.5 rounded-lg bg-neutral-900 dark:bg-white text-white dark:text-black font-bold">Create</button>
       </div>
     </form>
   </div>
 </div>

</BaseLayout>

<script>
  import { createClient } from '@supabase/supabase-js';
  import { openChat } from '../../lib/supabase';

  // Initialize Client
  const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.PUBLIC_SUPABASE_ANON_KEY
  );

  // --- TAB SWITCHING LOGIC ---
  const tabs = document.querySelectorAll('.tab-btn');
  const contents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Reset all tabs
      tabs.forEach(t => {
        t.classList.remove('border-black', 'dark:border-white', 'text-black', 'dark:text-white');
        t.classList.add('border-transparent', 'text-neutral-500');
      });

      // Activate clicked tab
      tab.classList.remove('border-transparent', 'text-neutral-500');
      tab.classList.add('border-black', 'dark:border-white', 'text-black', 'dark:text-white');

      // Show content
      contents.forEach(c => c.classList.add('hidden'));
      const targetId = tab.getAttribute('data-target');
      if (targetId) {
        document.getElementById(targetId)?.classList.remove('hidden');
      }
    });
  });

  // --- AVATAR UPLOAD LOGIC ---
  const avatarInput = document.getElementById('avatar-upload') as HTMLInputElement;
  
  if (avatarInput) {
    avatarInput.addEventListener('change', async (e) => {
      const target = e.target as HTMLInputElement;
      if (!target.files || target.files.length === 0) return;
      
      const file = target.files[0];
      const { data: sessionData } = await supabase.auth.getSession();
      const user = sessionData.session?.user;

      if (!user) {
        alert('You must be logged in to upload.');
        return;
      }

      // Upload File
      const fileExt = file.name.split('.').pop();
      const fileName = `${user.id}.${fileExt}`;
      const { error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(fileName, file, { upsert: true });

      if (uploadError) {
        console.error("Upload error:", uploadError);
        alert('Error uploading image.');
        return;
      }

      // Get URL
      const { data: urlData } = supabase.storage
        .from('avatars')
        .getPublicUrl(fileName);

      // Update Profile
      const { error: updateError } = await supabase
        .from('profiles')
        .update({ avatar_url: urlData.publicUrl })
        .eq('id', user.id);

      if (updateError) {
        console.error("Profile update error:", updateError);
        alert('Error updating profile.');
      } else {
        window.location.reload();
      }
    });
  }

  // --- SERVICE CREATION ---
  const svcModal = document.getElementById('service-modal');
  const addSvcBtn = document.getElementById('add-service-btn');
  const closeSvcBtn = document.getElementById('close-svc-modal');
  const svcForm = document.getElementById('service-form');

  if (addSvcBtn && svcModal && closeSvcBtn) {
    addSvcBtn.addEventListener('click', () => svcModal.classList.remove('hidden'));
    closeSvcBtn.addEventListener('click', () => svcModal.classList.add('hidden'));

    // Close on click outside
    svcModal.addEventListener('click', (e) => {
      if (e.target === svcModal) svcModal.classList.add('hidden');
    });
  }

  if (svcForm) {
    svcForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const { data: sessionData } = await supabase.auth.getSession();
      if (!sessionData.session) return;

      const { error } = await supabase.from('services').insert({
        title: (document.getElementById('svc-title') as HTMLInputElement).value,
        price: (document.getElementById('svc-price') as HTMLInputElement).value,
        description: (document.getElementById('svc-desc') as HTMLTextAreaElement).value,
        user_id: sessionData.session.user.id
      });

      if (error) alert(error.message);
      else {
        svcModal?.classList.add('hidden');
        window.location.reload();
      }
    });
  }

  // --- MESSAGE BUTTONS ---
  const messageBtns = ['message-btn', 'message-btn-large'];
  messageBtns.forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (btn) {
      btn.addEventListener('click', () => {
        const targetUserId = JSON.parse(btn.getAttribute('data-target-user-id') || 'null');
        if (targetUserId) {
          openChat(targetUserId);
        }
      });
    }
  });

</script>