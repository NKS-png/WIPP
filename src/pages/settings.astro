---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

// 1. Auth Check
const { data: { session } } = await supabase.auth.getSession();
if (!session) return Astro.redirect('/login');

// 2. Fetch Profile Data
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', session.user.id)
  .single();

if (!profile) return Astro.redirect('/login');
---

<BaseLayout title="Settings">
  <div class="max-w-6xl mx-auto px-6 py-12">
    
    <div class="flex flex-col md:flex-row gap-12">
      
      <aside class="w-full md:w-64 flex-shrink-0">
        <h1 class="text-3xl font-bold mb-8 text-neutral-900 dark:text-white">Settings</h1>
        <nav class="space-y-1">
          <a href="/settings" class="block px-4 py-2 rounded-lg bg-neutral-900 dark:bg-white text-white dark:text-black font-medium shadow-md">
            Edit Profile
          </a>
          <a href="#" class="block px-4 py-2 rounded-lg text-neutral-500 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white transition-colors">
            Account
          </a>
          <a href="#" class="block px-4 py-2 rounded-lg text-neutral-500 hover:bg-neutral-100 dark:hover:bg-neutral-800 hover:text-neutral-900 dark:hover:text-white transition-colors">
            Notifications
          </a>
          
          <div class="pt-6 mt-6 border-t border-neutral-100 dark:border-neutral-800">
             <a href={`/profile/${session.user.id}`} class="flex items-center gap-2 px-4 py-2 text-sm font-bold text-neutral-500 hover:text-neutral-900 dark:hover:text-white transition-colors">
               &larr; Back to Profile
             </a>
          </div>
        </nav>
      </aside>

      <main class="flex-1">
        <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl p-8 shadow-sm">
          
          <div class="mb-8 pb-6 border-b border-neutral-100 dark:border-neutral-800">
             <h2 class="text-xl font-bold text-neutral-900 dark:text-white">Public Profile</h2>
             <p class="text-neutral-500 text-sm mt-1">This information will be displayed publicly.</p>
          </div>
          
          <form id="settings-form" class="space-y-8">
            
            <div class="group relative mb-10">
              <label class="block text-xs font-bold text-neutral-500 uppercase mb-3">Banner & Avatar</label>
              
              <div class="relative h-48 w-full rounded-xl overflow-hidden bg-neutral-100 dark:bg-neutral-800 border-2 border-dashed border-neutral-300 dark:border-neutral-700 hover:border-neutral-500 transition-colors group/banner">
                {profile.banner_url ? (
                    <img id="banner-preview" src={profile.banner_url} class="w-full h-full object-cover" />
                ) : (
                    <div class="w-full h-full bg-gradient-to-r from-neutral-200 to-neutral-300 dark:from-neutral-800 dark:to-neutral-900"></div>
                )}
                <img id="banner-preview-new" class="absolute inset-0 w-full h-full object-cover hidden" />
                
                <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover/banner:opacity-100 transition-opacity cursor-pointer">
                   <span class="text-white font-bold text-sm flex items-center gap-2 backdrop-blur-sm bg-black/20 px-4 py-2 rounded-full">
                     ðŸ“· Change Cover
                   </span>
                </div>
                <input type="file" id="banner-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
              </div>

              <div class="absolute -bottom-8 left-6 w-24 h-24 rounded-full border-4 border-white dark:border-neutral-900 bg-neutral-200 dark:bg-neutral-800 overflow-hidden group/avatar shadow-lg">
                 {profile.avatar_url ? (
                    <img id="avatar-preview" src={profile.avatar_url} class="w-full h-full object-cover" />
                 ) : (
                    <div class="w-full h-full flex items-center justify-center font-bold text-2xl text-neutral-400">{profile.username?.[0]}</div>
                 )}
                 <img id="avatar-preview-new" class="absolute inset-0 w-full h-full object-cover hidden" />

                 <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover/avatar:opacity-100 transition-opacity cursor-pointer">
                    <span class="text-white text-xs font-bold">Edit</span>
                 </div>
                 <input type="file" id="avatar-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-8">
              <div>
                <label class="block text-xs font-bold text-neutral-500 uppercase mb-2">Full Name</label>
                <input 
                  type="text" 
                  id="full_name" 
                  value={profile.full_name || ''} 
                  class="input-field w-full" 
                  placeholder="e.g. Jane Doe"
                />
              </div>
              
              <div>
                <label class="block text-xs font-bold text-neutral-500 uppercase mb-2">Username</label>
                <div class="relative">
                  <span class="absolute left-3 top-3 text-neutral-400">@</span>
                  <input 
                    type="text" 
                    id="username" 
                    value={profile.username || ''} 
                    class="input-field w-full pl-8" 
                    placeholder="janedoe"
                  />
                </div>
              </div>
            </div>

            <div>
              <label class="block text-xs font-bold text-neutral-500 uppercase mb-2">Bio</label>
              <textarea 
                id="bio" 
                rows="3" 
                class="input-field w-full"
                placeholder="Tell us a little about yourself..."
              >{profile.bio || ''}</textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
               <div>
                <label class="block text-xs font-bold text-neutral-500 uppercase mb-2">Website</label>
                <input 
                  type="url" 
                  id="website" 
                  value={profile.website || ''} 
                  class="input-field w-full" 
                  placeholder="https://yoursite.com"
                />
              </div>
              <div>
                <label class="block text-xs font-bold text-neutral-500 uppercase mb-2">Location</label>
                <input 
                  type="text" 
                  id="location" 
                  value={profile.location || ''} 
                  class="input-field w-full" 
                  placeholder="e.g. Tokyo, Japan"
                />
              </div>
            </div>

            <div class="pt-6 border-t border-neutral-100 dark:border-neutral-800 flex items-center justify-end gap-4">
              <a href={`/profile/${session.user.id}`} class="text-sm font-bold text-neutral-500 hover:text-neutral-900 dark:hover:text-white transition-colors">Cancel</a>
              <button 
                type="submit" 
                id="save-btn"
                class="bg-neutral-900 dark:bg-white text-white dark:text-black px-8 py-3 rounded-full font-bold hover:opacity-90 transition-opacity flex items-center gap-2 shadow-lg"
              >
                <span>Save Changes</span>
                <span id="spinner" class="hidden animate-spin">âŸ³</span>
              </button>
            </div>

          </form>
        </div>
      </main>
    </div>
  </div>
</BaseLayout>

<script>
  import { supabase } from '../lib/supabase';

  const form = document.getElementById('settings-form');
  const avatarInput = document.getElementById('avatar-upload') as HTMLInputElement;
  const bannerInput = document.getElementById('banner-upload') as HTMLInputElement;
  const avatarPreviewNew = document.getElementById('avatar-preview-new') as HTMLImageElement;
  const bannerPreviewNew = document.getElementById('banner-preview-new') as HTMLImageElement;
  const saveBtn = document.getElementById('save-btn');
  const spinner = document.getElementById('spinner');

  // --- PREVIEW LOGIC ---
  function handlePreview(input, imgElement) {
    if(!input) return;
    input.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          imgElement.src = e.target?.result as string;
          imgElement.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });
  }

  handlePreview(avatarInput, avatarPreviewNew);
  handlePreview(bannerInput, bannerPreviewNew);

  // --- SUBMIT LOGIC ---
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // UI Loading State
    saveBtn.setAttribute('disabled', 'true');
    saveBtn.classList.add('opacity-70', 'cursor-not-allowed');
    spinner.classList.remove('hidden');

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) throw new Error('Not logged in');

      const updates: any = {
        full_name: (document.getElementById('full_name') as HTMLInputElement).value,
        username: (document.getElementById('username') as HTMLInputElement).value,
        bio: (document.getElementById('bio') as HTMLTextAreaElement).value,
        website: (document.getElementById('website') as HTMLInputElement).value,
        location: (document.getElementById('location') as HTMLInputElement).value,
        updated_at: new Date(),
      };

      // 1. Upload Avatar (if changed)
      if (avatarInput.files?.length > 0) {
        const file = avatarInput.files[0];
        // Timestamp ensures unique ID -> busts browser cache immediately
        const fileName = `${session.user.id}/avatar_${Date.now()}.${file.name.split('.').pop()}`;
        
        const { error: upErr } = await supabase.storage.from('avatars').upload(fileName, file);
        if (upErr) throw upErr;
        
        const { data } = supabase.storage.from('avatars').getPublicUrl(fileName);
        updates.avatar_url = data.publicUrl;
      }

      // 2. Upload Banner (if changed)
      if (bannerInput.files?.length > 0) {
        const file = bannerInput.files[0];
        const fileName = `${session.user.id}/banner_${Date.now()}.${file.name.split('.').pop()}`;
        
        // Ensure you have created the 'banners' bucket in Supabase!
        const { error: upErr } = await supabase.storage.from('banners').upload(fileName, file);
        if (upErr) throw upErr;
        
        const { data } = supabase.storage.from('banners').getPublicUrl(fileName);
        updates.banner_url = data.publicUrl;
      }

      // 3. Update Database
      const { error } = await supabase.from('profiles').update(updates).eq('id', session.user.id);
      if (error) throw error;

      alert('Settings saved successfully!');
      // Reload to see changes
      window.location.href = `/profile/${session.user.id}`;

    } catch (err: any) {
      console.error(err);
      alert('Error updating profile: ' + (err.message || "Unknown error"));
      
      // Reset UI on error
      saveBtn.removeAttribute('disabled');
      saveBtn.classList.remove('opacity-70', 'cursor-not-allowed');
      spinner.classList.add('hidden');
    }
  });
</script>

<style>
  .input-field {
    @apply px-4 py-3 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-neutral-900 dark:focus:ring-white transition-all;
  }
</style>