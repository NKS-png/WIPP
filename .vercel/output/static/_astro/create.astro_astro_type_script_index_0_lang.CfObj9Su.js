import{c as M}from"./index.C1Qlw3jS.js";const p=M("https://vgdmfnigbbdjvbtphnxh.supabase.co","sb_publishable_qNW9fKrKANJgEAL5KkhgLw_MKm7KvUv");let y=null,w=null;const L=document.getElementById("create-community-form"),E=document.getElementById("error-msg"),a=document.getElementById("submit-btn"),B=document.getElementById("upload-progress"),d=document.getElementById("progress-bar"),h=document.getElementById("progress-text"),c=document.getElementById("icon-dropzone"),T=document.getElementById("icon-input"),S=document.getElementById("icon-placeholder"),I=document.getElementById("icon-preview"),u=document.getElementById("banner-dropzone"),U=document.getElementById("banner-input"),_=document.getElementById("banner-placeholder"),k=document.getElementById("banner-preview");c.addEventListener("click",()=>T.click());c.addEventListener("dragover",e=>{e.preventDefault(),c.classList.add("border-purple-500","bg-purple-50","dark:bg-purple-900/10")});c.addEventListener("dragleave",()=>{c.classList.remove("border-purple-500","bg-purple-50","dark:bg-purple-900/10")});c.addEventListener("drop",e=>{e.preventDefault(),c.classList.remove("border-purple-500","bg-purple-50","dark:bg-purple-900/10");const t=e.dataTransfer?.files;t&&t[0]&&$(t[0])});T.addEventListener("change",e=>{const t=e.target;t.files&&t.files[0]&&$(t.files[0])});function $(e){if(!e.type.startsWith("image/")){g("Please upload an image file");return}if(e.size>2*1024*1024){g("Icon must be less than 2MB");return}y=e;const t=new FileReader;t.onload=n=>{const s=I.querySelector("img");s.src=n.target?.result,S.classList.add("hidden"),I.classList.remove("hidden")},t.readAsDataURL(e)}u.addEventListener("click",()=>U.click());u.addEventListener("dragover",e=>{e.preventDefault(),u.classList.add("border-purple-500","bg-purple-50","dark:bg-purple-900/10")});u.addEventListener("dragleave",()=>{u.classList.remove("border-purple-500","bg-purple-50","dark:bg-purple-900/10")});u.addEventListener("drop",e=>{e.preventDefault(),u.classList.remove("border-purple-500","bg-purple-50","dark:bg-purple-900/10");const t=e.dataTransfer?.files;t&&t[0]&&D(t[0])});U.addEventListener("change",e=>{const t=e.target;t.files&&t.files[0]&&D(t.files[0])});function D(e){if(!e.type.startsWith("image/")){g("Please upload an image file");return}if(e.size>5*1024*1024){g("Banner must be less than 5MB");return}w=e;const t=new FileReader;t.onload=n=>{const s=k.querySelector("img");s.src=n.target?.result,_.classList.add("hidden"),k.classList.remove("hidden")},t.readAsDataURL(e)}async function x(e,t,n){try{console.log(`Attempting to upload to bucket: ${t}`);const s=e.name.split(".").pop(),b=`${Math.random().toString(36).substring(2)}-${Date.now()}.${s}`,r=`${n}/${b}`;console.log(`Uploading file: ${r}`);const{data:o,error:l}=await p.storage.listBuckets();if(l)throw console.error("Bucket list error:",l),new Error(`Storage access error: ${l.message}`);if(!o?.some(P=>P.name===t))throw new Error(`Bucket "${t}" does not exist. Please create it in Supabase Dashboard.`);const{data:f,error:m}=await p.storage.from(t).upload(r,e,{cacheControl:"3600",upsert:!1});if(m)throw console.error("Upload error details:",m),new Error(`Upload failed: ${m.message}`);console.log("Upload successful:",f);const{data:{publicUrl:i}}=p.storage.from(t).getPublicUrl(r);return console.log("Public URL:",i),i}catch(s){throw console.error("Upload error:",s),s}}function g(e){E.innerText=e,E.classList.remove("hidden"),setTimeout(()=>E.classList.add("hidden"),8e3)}if(L){L.addEventListener("submit",async t=>{t.preventDefault();const n=a.innerHTML;a.innerHTML='<span class="animate-spin inline-block">⟳</span> Creating...',a.disabled=!0,a.classList.add("opacity-70","cursor-not-allowed"),E.classList.add("hidden");const s=document.getElementById("name").value.trim(),b=document.getElementById("description").value.trim();if(!s||!b){g("Please fill in all required fields."),a.innerHTML=n,a.disabled=!1,a.classList.remove("opacity-70","cursor-not-allowed");return}try{const{data:{session:r}}=await p.auth.getSession();if(!r){window.location.href="/login";return}let o=null,l=null;if(y||w){if(B.classList.remove("hidden"),d.style.width="0%",y)try{h.innerText="Uploading icon...",d.style.width="25%",o=await x(y,"projects","community-icons"),d.style.width="50%",console.log("Icon uploaded successfully:",o)}catch(i){throw console.error("Icon upload failed:",i),new Error(`Icon upload failed: ${i.message}`)}if(w)try{h.innerText="Uploading banner...",d.style.width="60%",l=await x(w,"projects","community-banners"),d.style.width="80%",console.log("Banner uploaded successfully:",l)}catch(i){throw console.error("Banner upload failed:",i),new Error(`Banner upload failed: ${i.message}`)}}h.innerText="Creating community...",console.log("Creating community with user:",r.user.id);const{data:v,error:f}=await p.from("communities").insert({name:s,description:b,image_url:o,banner_url:l,admin_id:r.user.id}).select().single();if(f)throw console.error("Community creation error:",f),f;d.style.width="90%";const{error:m}=await p.from("community_members").insert({community_id:v.id,user_id:r.user.id,role:"admin"});m&&console.warn("Auto-join error:",m.message),d.style.width="100%",h.innerText="Success! Redirecting...",setTimeout(()=>{window.location.href=`/c/${v.id}`},500)}catch(r){console.error("Error creating community:",r);let o="Failed to create community. Please try again.";r.message.includes("Bucket")?o=r.message+" Go to Supabase Dashboard → Storage → Create bucket.":r.code==="23505"?o="A community with this name already exists.":r.message&&(o=r.message),g(o),B.classList.add("hidden"),a.innerHTML=n,a.disabled=!1,a.classList.remove("opacity-70","cursor-not-allowed")}});const e=document.getElementById("description");e&&e.addEventListener("input",()=>{const t=500-e.value.length,n=e.previousElementSibling;n&&(n.innerHTML=`Description <span class="text-xs text-neutral-400">(${t} characters remaining)</span>`)})}
