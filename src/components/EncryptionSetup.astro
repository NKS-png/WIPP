---
// This component handles encryption setup for new users
---

<div id="encryption-setup-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center px-4 bg-black/80 backdrop-blur-sm">
  <div class="bg-white dark:bg-neutral-900 w-full max-w-md rounded-2xl shadow-2xl p-6 animate-fade-in-up">
    <div class="text-center mb-6">
      <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
      <h2 class="text-xl font-bold text-neutral-900 dark:text-white mb-2">Secure Your Messages</h2>
      <p class="text-sm text-neutral-600 dark:text-neutral-400">Set up end-to-end encryption to keep your conversations private</p>
    </div>

    <div id="setup-step-1" class="space-y-4">
      <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div class="text-sm">
            <p class="font-medium text-blue-900 dark:text-blue-100 mb-1">Why encryption?</p>
            <p class="text-blue-700 dark:text-blue-300">Your messages will be encrypted so only you and the recipient can read them. Not even Wipp can see your private conversations.</p>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <label class="block text-sm font-medium text-neutral-700 dark:text-neutral-300">
          Create an encryption password:
        </label>
        <input
          type="password"
          id="encryption-password"
          placeholder="Enter a strong password..."
          class="w-full px-4 py-3 border border-neutral-200 dark:border-neutral-700 rounded-xl bg-neutral-50 dark:bg-neutral-800 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          autocomplete="new-password"
        />
        
        <!-- Password Strength Indicator -->
        <div id="password-strength" class="hidden">
          <div class="flex items-center gap-2 mb-2">
            <div class="flex-1 bg-neutral-200 dark:bg-neutral-700 rounded-full h-2">
              <div id="strength-bar" class="h-2 rounded-full transition-all duration-300"></div>
            </div>
            <span id="strength-text" class="text-xs font-medium"></span>
          </div>
          <ul id="password-requirements" class="text-xs text-neutral-600 dark:text-neutral-400 space-y-1">
            <!-- Requirements will be populated by JavaScript -->
          </ul>
        </div>

        <input
          type="password"
          id="confirm-password"
          placeholder="Confirm your password..."
          class="w-full px-4 py-3 border border-neutral-200 dark:border-neutral-700 rounded-xl bg-neutral-50 dark:bg-neutral-800 text-neutral-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
          autocomplete="new-password"
        />
      </div>

      <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-4">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
          <div class="text-sm">
            <p class="font-medium text-amber-900 dark:text-amber-100 mb-1">Important!</p>
            <p class="text-amber-700 dark:text-amber-300">If you forget this password, you won't be able to read your encrypted messages. Store it safely!</p>
          </div>
        </div>
      </div>

      <div class="flex gap-3 pt-4">
        <button id="skip-encryption-btn" class="flex-1 px-4 py-3 border border-neutral-200 dark:border-neutral-700 text-neutral-700 dark:text-neutral-300 rounded-xl font-medium hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors">
          Skip for now
        </button>
        <button id="setup-encryption-btn" class="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-blue-500 text-white rounded-xl font-medium hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          Set up encryption
        </button>
      </div>
    </div>

    <div id="setup-step-2" class="hidden text-center space-y-4">
      <div class="animate-spin w-12 h-12 border-4 border-neutral-200 border-t-blue-500 rounded-full mx-auto"></div>
      <div>
        <h3 class="font-medium text-neutral-900 dark:text-white mb-2">Setting up encryption...</h3>
        <p class="text-sm text-neutral-600 dark:text-neutral-400">Generating your encryption keys securely</p>
      </div>
    </div>

    <div id="setup-step-3" class="hidden text-center space-y-4">
      <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>
      <div>
        <h3 class="font-medium text-neutral-900 dark:text-white mb-2">Encryption enabled!</h3>
        <p class="text-sm text-neutral-600 dark:text-neutral-400">Your messages are now protected with end-to-end encryption</p>
      </div>
      <button id="close-setup-btn" class="w-full px-4 py-3 bg-green-500 text-white rounded-xl font-medium hover:bg-green-600 transition-colors">
        Start messaging securely
      </button>
    </div>
  </div>
</div>

<script>
  // Import modules
  let keyManager = null;
  let supabase = null;
  
  // Initialize modules
  async function initializeModules() {
    try {
      const keyManagerModule = await import('../lib/keyManager.js');
      keyManager = keyManagerModule.keyManager;
    } catch (error) {
      console.error('Failed to load keyManager:', error);
      return false;
    }
    
    try {
      const supabaseModule = await import('../lib/supabase.ts');
      supabase = supabaseModule.supabase;
    } catch (error) {
      console.error('Failed to load supabase:', error);
      return false;
    }
    
    return true;
  }

  // Initialize modules and start the app
  initializeModules().then((success) => {
    if (!success) {
      console.error('Failed to initialize required modules');
      return;
    }
    
    // Initialize the encryption setup
    initializeEncryptionSetup();
  });

  function initializeEncryptionSetup() {

  const modal = document.getElementById('encryption-setup-modal');
  const step1 = document.getElementById('setup-step-1');
  const step2 = document.getElementById('setup-step-2');
  const step3 = document.getElementById('setup-step-3');
  
  const passwordInput = document.getElementById('encryption-password');
  const confirmPasswordInput = document.getElementById('confirm-password');
  const passwordStrength = document.getElementById('password-strength');
  const strengthBar = document.getElementById('strength-bar');
  const strengthText = document.getElementById('strength-text');
  const passwordRequirements = document.getElementById('password-requirements');
  
  const skipBtn = document.getElementById('skip-encryption-btn');
  const setupBtn = document.getElementById('setup-encryption-btn');
  const closeBtn = document.getElementById('close-setup-btn');

  // Password strength checking
  passwordInput?.addEventListener('input', (e) => {
    const password = e.target.value;
    
    if (password.length > 0) {
      passwordStrength.classList.remove('hidden');
      const validation = keyManager.validatePasswordStrength(password);
      
      // Update strength bar
      const strengthColors = {
        'very-weak': 'bg-red-500',
        'weak': 'bg-orange-500',
        'medium': 'bg-yellow-500',
        'strong': 'bg-blue-500',
        'very-strong': 'bg-green-500'
      };
      
      const strengthWidths = {
        'very-weak': '20%',
        'weak': '40%',
        'medium': '60%',
        'strong': '80%',
        'very-strong': '100%'
      };
      
      strengthBar.className = `h-2 rounded-full transition-all duration-300 ${strengthColors[validation.strength]}`;
      strengthBar.style.width = strengthWidths[validation.strength];
      strengthText.textContent = validation.strength.replace('-', ' ').toUpperCase();
      
      // Update requirements
      passwordRequirements.innerHTML = validation.issues.map(issue => 
        `<li class="flex items-center gap-2">
          <svg class="w-3 h-3 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          ${issue}
        </li>`
      ).join('');
      
      // Enable/disable setup button
      setupBtn.disabled = !validation.isValid;
    } else {
      passwordStrength.classList.add('hidden');
      setupBtn.disabled = true;
    }
  });

  // Confirm password validation
  confirmPasswordInput?.addEventListener('input', (e) => {
    const password = passwordInput.value;
    const confirm = e.target.value;
    
    if (confirm.length > 0) {
      if (password === confirm) {
        confirmPasswordInput.classList.remove('border-red-500');
        confirmPasswordInput.classList.add('border-green-500');
      } else {
        confirmPasswordInput.classList.remove('border-green-500');
        confirmPasswordInput.classList.add('border-red-500');
      }
    } else {
      confirmPasswordInput.classList.remove('border-red-500', 'border-green-500');
    }
  });

  // Setup encryption
  setupBtn?.addEventListener('click', async () => {
    const password = passwordInput.value;
    const confirm = confirmPasswordInput.value;
    
    if (password !== confirm) {
      alert('Passwords do not match');
      return;
    }
    
    const validation = keyManager.validatePasswordStrength(password);
    if (!validation.isValid) {
      alert('Please use a stronger password');
      return;
    }

    // Show loading step
    step1.classList.add('hidden');
    step2.classList.remove('hidden');

    try {
      // First check if migrations have been run
      const migrationCheck = await fetch('/api/encryption/check-migration');
      if (migrationCheck.ok) {
        const migrationData = await migrationCheck.json();
        if (!migrationData.migrations_complete) {
          throw new Error('Database not configured for encryption. Please run the SQL migrations first. See DATABASE_MIGRATION_INSTRUCTIONS.md');
        }
      }

      // Get current user
      if (!supabase) {
        throw new Error('Supabase not available');
      }
      
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        throw new Error('Not authenticated');
      }

      // Initialize encryption
      await keyManager.initializeUserEncryption(session.user.id, password);
      
      // Show success step
      step2.classList.add('hidden');
      step3.classList.remove('hidden');
      
    } catch (error) {
      console.error('Error setting up encryption:', error);
      
      let errorMessage = error.message;
      if (errorMessage.includes('Database not configured')) {
        errorMessage = 'Database not ready for encryption.\n\nPlease run the SQL migrations first:\n1. Go to your Supabase dashboard\n2. Open SQL Editor\n3. Run encryption-setup.sql\n4. Run enhanced-security-schema.sql\n\nSee DATABASE_MIGRATION_INSTRUCTIONS.md for details.';
      }
      
      alert('Failed to set up encryption: ' + errorMessage);
      
      // Go back to step 1
      step2.classList.add('hidden');
      step1.classList.remove('hidden');
    }
  });

  // Skip encryption
  skipBtn?.addEventListener('click', () => {
    modal.classList.add('hidden');
    localStorage.setItem('encryption-skipped', 'true');
  });

  // Close modal
  closeBtn?.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  // Show modal for new users
  window.showEncryptionSetup = () => {
    modal.classList.remove('hidden');
  };

  // Auto-show for new users (if not skipped and encryption is available)
  window.addEventListener('load', async () => {
    if (localStorage.getItem('encryption-skipped')) return;
    
    try {
      if (!supabase || !keyManager) return;
      
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;
      
      const hasKeys = await keyManager.hasEncryptionKeys(session.user.id);
      if (!hasKeys) {
        setTimeout(() => {
          modal.classList.remove('hidden');
        }, 2000); // Show after 2 seconds
      }
    } catch (error) {
      console.error('Error checking encryption setup:', error);
    }
  });
  } // End of initializeEncryptionSetup function
</script>

<style>
  .animate-fade-in-up {
    animation: fadeInUp 0.3s ease-out forwards;
  }

  @keyframes fadeInUp {
    from { 
      opacity: 0; 
      transform: translateY(20px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }
</style>