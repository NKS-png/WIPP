---
import ThemeToggle from './ThemeToggle.astro';
import UnifiedSearch from './UnifiedSearch.astro';
import { supabase } from '../lib/supabase';

const { cookies } = Astro;
const accessToken = cookies.get("sb-access-token")?.value;
const refreshToken = cookies.get("sb-refresh-token")?.value;

let session = null;
let user = null;
let profile = null;

if (accessToken && refreshToken) {
  const { data, error } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });

  if (!error) {
    session = data.session;
    user = data.session?.user;
    
    if (user) {
        const { data: profileData } = await supabase
            .from('profiles')
            .select('username, avatar_url, full_name')
            .eq('id', user.id)
            .maybeSingle();
        
        profile = profileData;
    }
  }
}

const displayName = profile?.username || profile?.full_name || user?.email?.split('@')[0] || 'User';
const displayInitial = displayName.charAt(0).toUpperCase();
---

<nav class="w-full sticky top-0 z-[60] transition-colors duration-300 px-6 pt-4">
  <div class="bg-stone-50/95 dark:bg-stone-900/95 backdrop-blur-sm border border-stone-200 dark:border-stone-700 rounded-2xl">
    <div class="max-w-6xl mx-auto px-6 h-20 flex justify-between items-center gap-4">
    
    <div class="flex items-center gap-6 lg:gap-8">
      <a href="/" class="flex items-center gap-2 group relative z-[70] flex-shrink-0">
        <img src="/logo.png" alt="Logo" class="h-16 w-auto dark:hidden group-hover:scale-105 transition-transform object-contain" />
        <img src="/darklogo.png" alt="Logo" class="h-16 w-auto hidden dark:block group-hover:scale-105 transition-transform object-contain" />
      </a>
      
      <div class="hidden lg:flex items-center gap-6 text-base font-normal text-stone-600 dark:text-stone-400">
        <a href="/explore" class="hover:text-stone-800 dark:hover:text-stone-200 transition-colors whitespace-nowrap">Explore</a>
        <a href="/about" class="hover:text-stone-800 dark:hover:text-stone-200 transition-colors whitespace-nowrap">About</a>
        <a href="/support" class="hover:text-stone-800 dark:hover:text-stone-200 transition-colors whitespace-nowrap">Support</a>
        <a href="/communities" class="hover:text-stone-800 dark:hover:text-stone-200 transition-colors whitespace-nowrap">Communities</a>
        {session && !Astro.url.pathname.includes('/inbox') && (
          <a href="/inbox" class="hover:text-stone-800 dark:hover:text-stone-200 transition-colors relative whitespace-nowrap" id="inbox-link">
            <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            Inbox
            <span id="unread-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold notification-dot">
              0
            </span>
          </a>
        )}
      </div>
    </div>

    <div class="flex-1 max-w-xs lg:max-w-md mx-4 hidden md:block relative">
      <UnifiedSearch showInNavbar={true} />
    </div>

    <div class="flex items-center gap-3 flex-shrink-0">
      <ThemeToggle />

      <button id="mobile-menu-btn" class="md:hidden p-2 -mr-2 rounded-xl hover:bg-stone-200 dark:hover:bg-stone-700 transition-colors text-stone-800 dark:text-stone-200 relative z-[70]">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

      <div class="hidden md:flex items-center gap-4">
        {session ? (
          <>
            <a href="/post" class="bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 text-base font-normal px-6 py-3 rounded-xl hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors whitespace-nowrap">
              Share Work
            </a>
            
            <div class="relative group">
              <button class="flex items-center focus:outline-none">
                {profile?.avatar_url ? (
                  <img src={profile.avatar_url} alt="Profile" class="h-10 w-10 rounded-xl object-cover border border-stone-300 dark:border-stone-600" />
                ) : (
                  <div class="h-10 w-10 rounded-xl bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 flex items-center justify-center text-base font-normal">
                    {displayInitial}
                  </div>
                )}
              </button>
              
              <div class="absolute right-0 top-full pt-2 w-56 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-out transform translate-y-2 group-hover:translate-y-0 z-[70]">
                <div class="bg-stone-50 dark:bg-stone-800 border border-stone-200 dark:border-stone-700 rounded-xl overflow-hidden">
                  <div class="px-4 py-3 border-b border-stone-200 dark:border-stone-700">
                    <p class="text-xs font-normal text-stone-500 dark:text-stone-400 uppercase tracking-wider mb-1">Signed in as</p>
                    <p class="text-sm font-normal text-stone-800 dark:text-stone-200 truncate">{displayName}</p>
                  </div>
                  
                  <!-- Encryption Status -->
                  <div class="px-4 py-2 border-b border-neutral-100 dark:border-neutral-800">
                    <div id="encryption-status" class="flex items-center gap-2 text-xs">
                      <div id="encryption-locked" class="flex items-center gap-2 text-amber-600">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span>Keys locked</span>
                        <button id="unlock-keys-navbar" class="text-blue-600 hover:text-blue-800 underline">Unlock</button>
                      </div>
                      <div id="encryption-unlocked" class="hidden flex items-center gap-2 text-green-600">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-3a1 1 0 011-1h2.586l6.414-6.414a6 6 0 015.743-7.743z" />
                        </svg>
                        <span>Keys unlocked</span>
                      </div>
                      <div id="encryption-none" class="hidden flex items-center gap-2 text-green-600 dark:text-green-400">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span>Auto-encrypted</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="py-1">
                    <a href={`/profile/${user.id}`} class="block px-4 py-2 text-sm hover:bg-stone-100 dark:hover:bg-stone-700 dark:text-stone-200">Your Profile</a>
                    <a href="/settings" class="block px-4 py-2 text-sm hover:bg-stone-100 dark:hover:bg-stone-700 dark:text-stone-200">Settings</a>
                    <a href="/communities" class="block px-4 py-2 text-sm hover:bg-stone-100 dark:hover:bg-stone-700 dark:text-stone-200">Communities</a>
                  </div>
                  <div class="border-t border-stone-200 dark:border-stone-700 py-1">
                    <form action="/api/auth/signout" method="post">
                       <button type="submit" class="w-full text-left block px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/10">Sign out</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </>
        ) : (
          <>
            <a href="/login" class="text-base font-normal text-stone-600 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200 whitespace-nowrap">Log In</a>
            <a href="/signup" class="text-base font-normal bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 px-6 py-3 rounded-xl hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors whitespace-nowrap">Sign Up</a>
          </>
        )}
      </div>
    </div>
  </div>
</nav>

<div id="mobile-menu" class="fixed inset-0 z-[9999] md:hidden bg-stone-50 dark:bg-stone-900 transform translate-x-full transition-transform duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] flex flex-col" data-state="closed">
  
  <div class="h-24 px-6 flex items-center justify-between">
      <span class="text-lg font-normal tracking-normal text-stone-500 dark:text-stone-400 uppercase">Menu</span>
      <button id="close-mobile-menu" class="p-3 bg-stone-200 dark:bg-stone-800 text-stone-800 dark:text-stone-200 hover:bg-stone-300 dark:hover:bg-stone-700 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
  </div>

  <div class="flex-1 overflow-y-auto px-6 py-4 flex flex-col">
    <!-- Mobile Search -->
    <div class="mb-6">
      <UnifiedSearch placeholder="Search..." maxResults={10} />
    </div>
    
    <nav class="flex flex-col gap-8">
      <a href="/explore" class="mobile-link text-4xl font-normal text-stone-800 dark:text-stone-200 hover:text-stone-600 dark:hover:text-stone-400 transition-colors">Explore</a>
      <a href="/about" class="mobile-link text-4xl font-normal text-stone-800 dark:text-stone-200 hover:text-stone-600 dark:hover:text-stone-400 transition-colors">About</a>
      <a href="/support" class="mobile-link text-4xl font-normal text-stone-800 dark:text-stone-200 hover:text-stone-600 dark:hover:text-stone-400 transition-colors">Support</a>
      <a href="/communities" class="mobile-link text-4xl font-normal text-stone-800 dark:text-stone-200 hover:text-stone-600 dark:hover:text-stone-400 transition-colors">Community</a>
      {session && !Astro.url.pathname.includes('/inbox') && (
        <a href="/inbox" class="mobile-link text-4xl font-normal text-stone-800 dark:text-stone-200 hover:text-stone-600 dark:hover:text-stone-400 transition-colors relative">
          Inbox
          <span id="mobile-unread-badge" class="hidden absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold notification-dot">
            0
          </span>
        </a>
      )}
    </nav>

    <div class="mt-auto pt-8 pb-8">
      <hr class="border-stone-300 dark:border-stone-700 mb-8" />
      
      {session ? (
        <div class="flex flex-col gap-6">
          <div class="flex items-center gap-4">
            <img src={profile?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${displayName}`} class="w-14 h-14 bg-stone-300 border border-stone-400 dark:border-stone-600" />
            <div>
              <p class="font-normal text-xl text-stone-800 dark:text-stone-200">{displayName}</p>
              <a href={`/profile/${user.id}`} class="text-sm text-stone-600 dark:text-stone-400 hover:text-stone-800 dark:hover:text-stone-200">View Profile â†’</a>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
              <a href="/settings" class="text-center py-4 bg-stone-200 dark:bg-stone-800 font-normal text-stone-800 dark:text-stone-200">Settings</a>
              <form action="/api/auth/signout" method="post" class="w-full">
                <button type="submit" class="w-full h-full text-center py-4 bg-red-50 dark:bg-red-900/10 text-red-600 font-normal">Sign Out</button>
              </form>
          </div>

          <a href="/post" class="w-full text-center py-5 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 font-normal text-xl hover:bg-stone-700 dark:hover:bg-stone-300 transition-colors">
            Share New Work
          </a>
        </div>
      ) : (
        <div class="flex flex-col gap-4">
          <a href="/login" class="w-full text-center py-5 border-2 border-stone-300 dark:border-stone-700 font-normal text-stone-800 dark:text-stone-200 text-xl">Log In</a>
          <a href="/signup" class="w-full text-center py-5 bg-stone-800 dark:bg-stone-200 text-stone-50 dark:text-stone-900 font-normal text-xl">Sign Up Free</a>
        </div>
      )}
    </div>
  </div>
</div>

<style>
  /* Menu Animation State */
  #mobile-menu[data-state="open"] {
    transform: translateX(0);
  }
</style>

<script>
  import { supabase } from '../lib/supabase';
  const isDev = window.location.hostname === 'localhost';

  // --- AUTH SYNC ---
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  const accessToken = getCookie('sb-access-token');
  const refreshToken = getCookie('sb-refresh-token');
  if (accessToken && refreshToken) {
    supabase.auth.setSession({ access_token: accessToken, refresh_token: refreshToken });
  }

  supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' && session) {
      const cookieOptions = isDev ? 'path=/; max-age=31536000; SameSite=Lax' : 'path=/; max-age=31536000; SameSite=Lax; Secure';
      document.cookie = `sb-access-token=${session.access_token}; ${cookieOptions}`;
      document.cookie = `sb-refresh-token=${session.refresh_token}; ${cookieOptions}`;
      
      // CRITICAL FIX: Prevent infinite reload loops
      if (!document.cookie.includes('sb-access-token')) {
        if (!sessionStorage.getItem('auth_retry')) {
          sessionStorage.setItem('auth_retry', 'true');
          window.location.reload();
        }
      } else {
        // Reset the flag on success
        sessionStorage.removeItem('auth_retry');
      }
    } else if (event === 'SIGNED_OUT') {
      document.cookie = 'sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
      document.cookie = 'sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
      if (document.cookie.includes('sb-access-token')) {
        if (!sessionStorage.getItem('signout_retry')) {
          sessionStorage.setItem('signout_retry', 'true');
          window.location.reload();
        }
      } else {
        sessionStorage.removeItem('signout_retry');
      }
    }
  });

  // --- MOBILE MENU LOGIC ---
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const closeMobileMenuBtn = document.getElementById('close-mobile-menu');
  const mobileMenu = document.getElementById('mobile-menu');
  const body = document.body;

  function openMenu() {
    if (mobileMenu) {
      mobileMenu.setAttribute('data-state', 'open');
      body.style.overflow = 'hidden'; // Lock scroll
    }
  }

  function closeMenu() {
    if (mobileMenu) {
      mobileMenu.setAttribute('data-state', 'closed');
      body.style.overflow = ''; // Unlock scroll
    }
  }

  mobileMenuBtn?.addEventListener('click', openMenu);
  closeMobileMenuBtn?.addEventListener('click', closeMenu);

  const links = mobileMenu?.querySelectorAll('a');
  links?.forEach(link => {
    link.addEventListener('click', closeMenu);
  });

  // --- UNREAD COUNT ---
  async function updateUnreadCount() {
    try {
      const response = await fetch('/api/unread-count');
      if (response.ok) {
        const { count } = await response.json();
        
        const badge = document.getElementById('unread-badge');
        const mobileBadge = document.getElementById('mobile-unread-badge');
        
        if (count && count > 0) {
          const displayCount = count > 99 ? '99+' : count.toString();
          
          if (badge) {
            badge.textContent = displayCount;
            badge.classList.remove('hidden');
          }
          if (mobileBadge) {
            mobileBadge.textContent = displayCount;
            mobileBadge.classList.remove('hidden');
          }
          
          // Play notification sound if count increased
          const lastCount = parseInt(localStorage.getItem('lastUnreadCount') || '0');
          if (count > lastCount) {
            playNotificationSound();
            
            // Show notification if not on inbox page
            if (!window.location.pathname.includes('/inbox') && window.showNotification) {
              window.showNotification(`You have ${count} unread message${count > 1 ? 's' : ''}`, 'info', 4000);
            }
          }
          localStorage.setItem('lastUnreadCount', count.toString());
        } else {
          if (badge) badge.classList.add('hidden');
          if (mobileBadge) mobileBadge.classList.add('hidden');
          localStorage.setItem('lastUnreadCount', '0');
        }
      }
    } catch (error) {
      console.log('Error updating unread count:', error);
    }
  }

  // Notification sound
  function playNotificationSound() {
    try {
      // Create a subtle notification sound
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
      
      gainNode.gain.setValueAtTime(0, audioContext.currentTime);
      gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
    } catch (error) {
      console.log('Could not play notification sound:', error);
    }
  }

  // Make notification sound and update function globally available
  window.playNotificationSound = playNotificationSound;
  window.updateNavbarUnreadCount = updateUnreadCount;

  // --- ENCRYPTION STATUS ---
  async function updateEncryptionStatus() {
    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return;
      
      const encryptionLocked = document.getElementById('encryption-locked');
      const encryptionUnlocked = document.getElementById('encryption-unlocked');
      const encryptionNone = document.getElementById('encryption-none');
      
      // For automatic encryption, always show as auto-encrypted
      encryptionLocked?.classList.add('hidden');
      encryptionUnlocked?.classList.add('hidden');
      encryptionNone?.classList.remove('hidden');
      
    } catch (error) {
      console.error('Error updating encryption status:', error);
      // Default to showing auto-encrypted status
      const encryptionNone = document.getElementById('encryption-none');
      encryptionNone?.classList.remove('hidden');
    }
  }

  // Update encryption status on page load and periodically
  updateEncryptionStatus();
  setInterval(updateEncryptionStatus, 5000);

  // Update on page load
  updateUnreadCount();

  // Update every 5 seconds for more responsive updates
  setInterval(updateUnreadCount, 5000);

  // Update on new messages via realtime subscription
  supabase
    .channel('navbar_unread')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'messages'
    }, () => {
      setTimeout(updateUnreadCount, 1000); // Small delay to ensure data is available
    })
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'message_reads'
    }, () => {
      setTimeout(updateUnreadCount, 500); // Update when messages are marked as read
    })
    .subscribe();
</script>