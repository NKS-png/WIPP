---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

// Server-side auth check
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  const { data } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  currentUser = data.session?.user;
}

// Debug queries
let debugResults = {
  allPosts: null,
  allPostsError: null,
  userPosts: null,
  userPostsError: null,
  communityPosts: null,
  communityPostsError: null,
  communities: null,
  communitiesError: null
};

try {
  // Get all posts
  const { data: allPosts, error: allPostsError } = await supabase
    .from('posts')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(10);
  
  debugResults.allPosts = allPosts;
  debugResults.allPostsError = allPostsError;

  if (currentUser) {
    // Get user's posts
    const { data: userPosts, error: userPostsError } = await supabase
      .from('posts')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });
    
    debugResults.userPosts = userPosts;
    debugResults.userPostsError = userPostsError;
  }

  // Get communities
  const { data: communities, error: communitiesError } = await supabase
    .from('communities')
    .select('*')
    .limit(5);
  
  debugResults.communities = communities;
  debugResults.communitiesError = communitiesError;

  if (communities && communities.length > 0) {
    // Get posts for first community
    const { data: communityPosts, error: communityPostsError } = await supabase
      .from('posts')
      .select('*')
      .eq('community_id', communities[0].id)
      .order('created_at', { ascending: false });
    
    debugResults.communityPosts = communityPosts;
    debugResults.communityPostsError = communityPostsError;
  }

} catch (err) {
  console.error('Debug query error:', err);
}
---

<BaseLayout title="Posts Debug">
  <div class="max-w-6xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-bold mb-8 dark:text-white">Posts Debug Information</h1>
    
    <div class="space-y-8">
      
      <!-- User Info -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">Current User</h2>
        <div class="space-y-2">
          <p class="dark:text-neutral-300">
            <strong>Logged in:</strong> {currentUser ? 'Yes' : 'No'}
          </p>
          {currentUser && (
            <>
              <p class="dark:text-neutral-300">
                <strong>User ID:</strong> {currentUser.id}
              </p>
              <p class="dark:text-neutral-300">
                <strong>Email:</strong> {currentUser.email}
              </p>
            </>
          )}
        </div>
      </div>

      <!-- All Posts -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">All Posts (Latest 10)</h2>
        {debugResults.allPostsError ? (
          <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg">
            <p class="text-red-600 dark:text-red-400 font-medium">Error:</p>
            <pre class="text-sm text-red-500 dark:text-red-300 mt-2">{JSON.stringify(debugResults.allPostsError, null, 2)}</pre>
          </div>
        ) : (
          <div class="space-y-4">
            <p class="text-green-600 dark:text-green-400 font-medium">
              Found {debugResults.allPosts?.length || 0} posts
            </p>
            {debugResults.allPosts && debugResults.allPosts.length > 0 && (
              <div class="space-y-3">
                {debugResults.allPosts.map((post) => (
                  <div class="bg-neutral-50 dark:bg-neutral-800 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <p><strong>ID:</strong> {post.id}</p>
                        <p><strong>User ID:</strong> {post.user_id}</p>
                        <p><strong>Community ID:</strong> {post.community_id || 'None'}</p>
                        <p><strong>Type:</strong> {post.type || 'None'}</p>
                      </div>
                      <div>
                        <p><strong>Created:</strong> {new Date(post.created_at).toLocaleString()}</p>
                        <p><strong>Content:</strong> {post.content?.substring(0, 50)}...</p>
                        <p><strong>Has Image:</strong> {post.image_url ? 'Yes' : 'No'}</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      <!-- User Posts -->
      {currentUser && (
        <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
          <h2 class="text-xl font-bold mb-4 dark:text-white">Current User's Posts</h2>
          {debugResults.userPostsError ? (
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg">
              <p class="text-red-600 dark:text-red-400 font-medium">Error:</p>
              <pre class="text-sm text-red-500 dark:text-red-300 mt-2">{JSON.stringify(debugResults.userPostsError, null, 2)}</pre>
            </div>
          ) : (
            <div class="space-y-4">
              <p class="text-green-600 dark:text-green-400 font-medium">
                Found {debugResults.userPosts?.length || 0} posts by current user
              </p>
              {debugResults.userPosts && debugResults.userPosts.length > 0 && (
                <div class="space-y-3">
                  {debugResults.userPosts.map((post) => (
                    <div class="bg-neutral-50 dark:bg-neutral-800 p-4 rounded-lg">
                      <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <p><strong>ID:</strong> {post.id}</p>
                          <p><strong>Community ID:</strong> {post.community_id || 'None'}</p>
                          <p><strong>Type:</strong> {post.type || 'None'}</p>
                        </div>
                        <div>
                          <p><strong>Created:</strong> {new Date(post.created_at).toLocaleString()}</p>
                          <p><strong>Content:</strong> {post.content?.substring(0, 50)}...</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      )}

      <!-- Communities -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">Communities</h2>
        {debugResults.communitiesError ? (
          <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg">
            <p class="text-red-600 dark:text-red-400 font-medium">Error:</p>
            <pre class="text-sm text-red-500 dark:text-red-300 mt-2">{JSON.stringify(debugResults.communitiesError, null, 2)}</pre>
          </div>
        ) : (
          <div class="space-y-4">
            <p class="text-green-600 dark:text-green-400 font-medium">
              Found {debugResults.communities?.length || 0} communities
            </p>
            {debugResults.communities && debugResults.communities.length > 0 && (
              <div class="space-y-3">
                {debugResults.communities.map((community) => (
                  <div class="bg-neutral-50 dark:bg-neutral-800 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <p><strong>ID:</strong> {community.id}</p>
                        <p><strong>Name:</strong> {community.name}</p>
                        <p><strong>Admin ID:</strong> {community.admin_id}</p>
                      </div>
                      <div>
                        <p><strong>Created:</strong> {new Date(community.created_at).toLocaleString()}</p>
                        <p><strong>Description:</strong> {community.description?.substring(0, 50)}...</p>
                        <a href={`/c/${community.id}`} class="text-blue-600 hover:text-blue-800 text-sm">â†’ View Community</a>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      <!-- Community Posts -->
      {debugResults.communities && debugResults.communities.length > 0 && (
        <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
          <h2 class="text-xl font-bold mb-4 dark:text-white">
            Posts in "{debugResults.communities[0].name}" Community
          </h2>
          {debugResults.communityPostsError ? (
            <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg">
              <p class="text-red-600 dark:text-red-400 font-medium">Error:</p>
              <pre class="text-sm text-red-500 dark:text-red-300 mt-2">{JSON.stringify(debugResults.communityPostsError, null, 2)}</pre>
            </div>
          ) : (
            <div class="space-y-4">
              <p class="text-green-600 dark:text-green-400 font-medium">
                Found {debugResults.communityPosts?.length || 0} posts in this community
              </p>
              {debugResults.communityPosts && debugResults.communityPosts.length > 0 && (
                <div class="space-y-3">
                  {debugResults.communityPosts.map((post) => (
                    <div class="bg-neutral-50 dark:bg-neutral-800 p-4 rounded-lg">
                      <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <p><strong>ID:</strong> {post.id}</p>
                          <p><strong>User ID:</strong> {post.user_id}</p>
                          <p><strong>Type:</strong> {post.type || 'None'}</p>
                        </div>
                        <div>
                          <p><strong>Created:</strong> {new Date(post.created_at).toLocaleString()}</p>
                          <p><strong>Content:</strong> {post.content?.substring(0, 50)}...</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      )}

      <!-- Test Buttons -->
      <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 p-6 rounded-xl">
        <h2 class="text-xl font-bold mb-4 dark:text-white">Test Actions</h2>
        <div class="flex gap-4 flex-wrap">
          <button id="create-test-post" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Create Test Post
          </button>
          <button id="refresh-data" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
            Refresh Data
          </button>
          <a href="/communities" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 inline-block">
            Go to Communities
          </a>
        </div>
        <div id="test-results" class="mt-4 p-4 bg-neutral-50 dark:bg-neutral-800 rounded-lg hidden">
          <h3 class="font-medium mb-2 dark:text-white">Test Results:</h3>
          <pre id="test-output" class="text-sm text-neutral-600 dark:text-neutral-300"></pre>
        </div>
      </div>

    </div>
  </div>
</BaseLayout>

<script define:vars={{ firstCommunityId: debugResults.communities?.[0]?.id }}>
  const testResults = document.getElementById('test-results');
  const testOutput = document.getElementById('test-output');

  function showResult(result) {
    testResults.classList.remove('hidden');
    testOutput.textContent = JSON.stringify(result, null, 2);
  }

  // Create test post
  document.getElementById('create-test-post').addEventListener('click', async () => {
    if (!firstCommunityId) {
      showResult({ error: 'No community available for testing' });
      return;
    }

    try {
      const formData = new FormData();
      formData.append('community_id', firstCommunityId);
      formData.append('content', `Test post created at ${new Date().toLocaleString()}`);
      formData.append('type', 'portfolio');

      const response = await fetch('/api/community/post', {
        method: 'POST',
        body: formData
      });
      
      const result = {
        status: response.status,
        statusText: response.statusText,
        body: await response.text()
      };
      
      showResult(result);
    } catch (error) {
      showResult({ error: error.message });
    }
  });

  // Refresh data
  document.getElementById('refresh-data').addEventListener('click', () => {
    window.location.reload();
  });
</script>