---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

// Get session from cookies (server-side auth)
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  const { data } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  currentUser = data.session?.user;
}

// Redirect if not logged in
if (!currentUser) {
  return Astro.redirect('/login');
}

// Get some test data
let testData = {
  conversations: [],
  participants: [],
  profiles: [],
  messages: []
};

try {
  // Get conversations
  const { data: conversations } = await supabase
    .from('conversations')
    .select('*')
    .limit(5);
  testData.conversations = conversations || [];

  // Get participants
  const { data: participants } = await supabase
    .from('conversation_participants')
    .select('*')
    .limit(5);
  testData.participants = participants || [];

  // Get profiles
  const { data: profiles } = await supabase
    .from('profiles')
    .select('id, username, full_name')
    .limit(5);
  testData.profiles = profiles || [];

  // Get messages
  const { data: messages } = await supabase
    .from('messages')
    .select('*')
    .limit(5);
  testData.messages = messages || [];
} catch (error) {
  console.error('Error fetching test data:', error);
}
---

<BaseLayout title="Messaging Test">
  <div class="min-h-screen bg-white dark:bg-neutral-900 py-8">
    <div class="max-w-4xl mx-auto px-4">
      <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-lg p-6 mb-6">
        <h1 class="text-2xl font-bold text-neutral-900 dark:text-white mb-4">
          Messaging System Test
        </h1>
        <p class="text-neutral-600 dark:text-neutral-400 mb-6">
          Current User: {currentUser.email}
        </p>

        <!-- Test Data Display -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-neutral-100 dark:bg-neutral-700 p-4 rounded-lg">
            <h3 class="font-bold mb-2">Conversations ({testData.conversations.length})</h3>
            <pre class="text-xs overflow-auto">{JSON.stringify(testData.conversations, null, 2)}</pre>
          </div>
          
          <div class="bg-neutral-100 dark:bg-neutral-700 p-4 rounded-lg">
            <h3 class="font-bold mb-2">Participants ({testData.participants.length})</h3>
            <pre class="text-xs overflow-auto">{JSON.stringify(testData.participants, null, 2)}</pre>
          </div>
          
          <div class="bg-neutral-100 dark:bg-neutral-700 p-4 rounded-lg">
            <h3 class="font-bold mb-2">Profiles ({testData.profiles.length})</h3>
            <pre class="text-xs overflow-auto">{JSON.stringify(testData.profiles, null, 2)}</pre>
          </div>
          
          <div class="bg-neutral-100 dark:bg-neutral-700 p-4 rounded-lg">
            <h3 class="font-bold mb-2">Messages ({testData.messages.length})</h3>
            <pre class="text-xs overflow-auto">{JSON.stringify(testData.messages, null, 2)}</pre>
          </div>
        </div>

        <!-- Test Message Form -->
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-6">
          <h3 class="text-lg font-bold text-yellow-800 dark:text-yellow-200 mb-3">
            Test Message Sending
          </h3>
          
          <div class="space-y-4">
            <input 
              type="text" 
              id="test-conversation-id"
              placeholder="Enter conversation ID"
              class="w-full px-4 py-3 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white"
            />
            
            <input 
              type="text" 
              id="test-message-content"
              placeholder="Enter test message"
              value="Test message from messaging test page"
              class="w-full px-4 py-3 border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-700 text-neutral-900 dark:text-white"
            />
            
            <div class="flex gap-2">
              <button 
                id="test-send-original"
                class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors"
              >
                Test Original API
              </button>
              
              <button 
                id="test-send-simple"
                class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition-colors"
              >
                Test Simple API
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Area -->
      <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-lg p-6">
        <h2 class="text-xl font-bold text-neutral-900 dark:text-white mb-4">
          Test Results
        </h2>
        <pre id="test-results" class="bg-neutral-100 dark:bg-neutral-900 p-4 rounded-lg text-sm overflow-auto max-h-96 text-neutral-800 dark:text-neutral-200">
Click a test button to see results...
        </pre>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const resultsEl = document.getElementById('test-results');
  const conversationIdInput = document.getElementById('test-conversation-id') as HTMLInputElement;
  const messageContentInput = document.getElementById('test-message-content') as HTMLInputElement;

  async function testAPI(endpoint: string, label: string) {
    if (!resultsEl || !conversationIdInput || !messageContentInput) return;
    
    const conversationId = conversationIdInput.value.trim();
    const content = messageContentInput.value.trim();
    
    if (!conversationId) {
      resultsEl.textContent = 'Please enter a conversation ID first';
      return;
    }
    
    if (!content) {
      resultsEl.textContent = 'Please enter message content';
      return;
    }
    
    resultsEl.textContent = `Testing ${label}...`;
    
    try {
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          conversation_id: conversationId,
          content: content
        })
      });
      
      const data = await response.json();
      resultsEl.textContent = `${label} Result:\n${JSON.stringify(data, null, 2)}`;
    } catch (error) {
      resultsEl.textContent = `${label} Error: ${error.message}`;
    }
  }

  document.getElementById('test-send-original')?.addEventListener('click', () => {
    testAPI('/api/send-message', 'Original API');
  });

  document.getElementById('test-send-simple')?.addEventListener('click', () => {
    testAPI('/api/send-message-simple', 'Simple API');
  });
</script>
</BaseLayout>