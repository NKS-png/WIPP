import{supabase as l}from"./supabase.DCKg3lBM.js";import"./index.C1Qlw3jS.js";const I=window.location.hostname==="localhost";function f(e){const n=`; ${document.cookie}`.split(`; ${e}=`);if(n.length===2)return n.pop().split(";").shift()}const m=f("sb-access-token"),h=f("sb-refresh-token");m&&h&&l.auth.setSession({access_token:m,refresh_token:h});l.auth.onAuthStateChange((e,t)=>{if(e==="SIGNED_IN"&&t){const n=I?"path=/; max-age=31536000; SameSite=Lax":"path=/; max-age=31536000; SameSite=Lax; Secure";document.cookie=`sb-access-token=${t.access_token}; ${n}`,document.cookie=`sb-refresh-token=${t.refresh_token}; ${n}`,document.cookie.includes("sb-access-token")?sessionStorage.removeItem("auth_retry"):sessionStorage.getItem("auth_retry")||(sessionStorage.setItem("auth_retry","true"),window.location.reload())}else e==="SIGNED_OUT"&&(document.cookie="sb-access-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie="sb-refresh-token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",document.cookie.includes("sb-access-token")?sessionStorage.getItem("signout_retry")||(sessionStorage.setItem("signout_retry","true"),window.location.reload()):sessionStorage.removeItem("signout_retry"))});const L=document.getElementById("mobile-menu-btn"),E=document.getElementById("close-mobile-menu"),r=document.getElementById("mobile-menu"),y=document.body;function S(){r&&(r.setAttribute("data-state","open"),y.style.overflow="hidden")}function v(){r&&(r.setAttribute("data-state","closed"),y.style.overflow="")}L?.addEventListener("click",S);E?.addEventListener("click",v);const T=r?.querySelectorAll("a");T?.forEach(e=>{e.addEventListener("click",v)});async function d(){try{const e=await fetch("/api/unread-count");if(e.ok){const{count:t}=await e.json(),n=document.getElementById("unread-badge"),o=document.getElementById("mobile-unread-badge");if(t&&t>0){const s=t>99?"99+":t.toString();n&&(n.textContent=s,n.classList.remove("hidden")),o&&(o.textContent=s,o.classList.remove("hidden"));const w=parseInt(localStorage.getItem("lastUnreadCount")||"0");t>w&&(b(),!window.location.pathname.includes("/inbox")&&window.showNotification&&window.showNotification(`You have ${t} unread message${t>1?"s":""}`,"info",4e3)),localStorage.setItem("lastUnreadCount",t.toString())}else n&&n.classList.add("hidden"),o&&o.classList.add("hidden"),localStorage.setItem("lastUnreadCount","0")}}catch(e){console.log("Error updating unread count:",e)}}const a=document.getElementById("navbar-search"),i=document.getElementById("search-results"),u=document.getElementById("search-loading"),c=document.getElementById("search-empty"),g=document.getElementById("search-list");let p;a&&(a.addEventListener("input",e=>{const t=e.target.value.trim();if(clearTimeout(p),t.length<2){i.classList.add("hidden");return}p=setTimeout(()=>{x(t)},300)}),a.addEventListener("focus",()=>{a.value.trim().length>=2&&i.classList.remove("hidden")}),document.addEventListener("click",e=>{!a.contains(e.target)&&!i.contains(e.target)&&i.classList.add("hidden")}));async function x(e){if(a){i.classList.remove("hidden"),u.classList.remove("hidden"),c.classList.add("hidden"),g.innerHTML="";try{const n=await(await fetch(`/api/search-users?q=${encodeURIComponent(e)}`)).json();u.classList.add("hidden"),n.users&&n.users.length>0?(c.classList.add("hidden"),n.users.forEach(o=>{const s=document.createElement("a");s.href=`/profile/${o.id}`,s.className="flex items-center gap-3 px-4 py-3 hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors",s.innerHTML=`
            <img src="${o.avatar}" alt="${o.displayName}" class="w-8 h-8 rounded-full object-cover" />
            <div class="flex-1 min-w-0">
              <div class="font-medium text-neutral-900 dark:text-white truncate">${o.displayName}</div>
              <div class="text-xs text-neutral-500 truncate">@${o.username}</div>
            </div>
          `,s.addEventListener("click",()=>{i.classList.add("hidden"),a.value=""}),g.appendChild(s)})):c.classList.remove("hidden")}catch(t){console.error("Search error:",t),u.classList.add("hidden"),c.classList.remove("hidden"),c.textContent="Search failed. Please try again."}}}function b(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(800,e.currentTime),t.frequency.setValueAtTime(600,e.currentTime+.1),n.gain.setValueAtTime(0,e.currentTime),n.gain.linearRampToValueAtTime(.1,e.currentTime+.01),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.2),t.start(e.currentTime),t.stop(e.currentTime+.2)}catch(e){console.log("Could not play notification sound:",e)}}window.playNotificationSound=b;window.updateNavbarUnreadCount=d;async function k(){try{const{data:{session:e}}=await l.auth.getSession();if(!e)return;const t=document.getElementById("encryption-locked"),n=document.getElementById("encryption-unlocked"),o=document.getElementById("encryption-none");t?.classList.add("hidden"),n?.classList.add("hidden"),o?.classList.remove("hidden")}catch(e){console.error("Error updating encryption status:",e),document.getElementById("encryption-none")?.classList.remove("hidden")}}k();setInterval(k,5e3);d();setInterval(d,1e4);l.channel("navbar_unread").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},()=>{setTimeout(d,1e3)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reads"},()=>{setTimeout(d,500)}).subscribe();
