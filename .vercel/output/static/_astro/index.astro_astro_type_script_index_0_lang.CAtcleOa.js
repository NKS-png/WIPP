const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/supabase.DCKg3lBM.js","_astro/index.C1Qlw3jS.js"])))=>i.map(i=>d[i]);
import{_ as M}from"./preload-helper.BlTxHScW.js";let v=null,O=null;async function R(){try{v=(await M(()=>import("./supabase.DCKg3lBM.js"),__vite__mapDeps([0,1]))).supabase}catch(a){return console.error("Failed to load supabase:",a),!1}try{O=(await M(()=>import("./keyManager.R0xhbMgW.js"),[])).keyManager}catch(a){console.log("Encryption not available:",a.message)}return!0}R().then(a=>{if(!a){console.error("Failed to initialize required modules"),$();return}V()});function $(){console.log("Initializing basic inbox functionality...");const a=document.getElementById("search-input"),c=document.querySelectorAll(".conversation-item");a&&a.addEventListener("input",i=>{const b=i.target.value.toLowerCase();c.forEach(m=>{(m.textContent?.toLowerCase()||"").includes(b)?m.style.display="block":m.style.display="none"})});const y=document.getElementById("new-message-btn"),r=document.getElementById("new-message-modal"),E=document.getElementById("close-modal-btn"),I=document.getElementById("cancel-message-btn");y?.addEventListener("click",()=>{r.classList.remove("hidden")});function u(){r.classList.add("hidden")}E?.addEventListener("click",u),I?.addEventListener("click",u),r?.addEventListener("click",i=>{i.target===r&&u()})}function V(){const a=document.getElementById("search-input"),c=document.querySelectorAll(".conversation-item");a&&a.addEventListener("input",e=>{const t=e.target.value.toLowerCase();c.forEach(n=>{(n.textContent?.toLowerCase()||"").includes(t)?n.style.display="block":n.style.display="none"})});function y(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(800,e.currentTime),t.frequency.setValueAtTime(600,e.currentTime+.1),n.gain.setValueAtTime(0,e.currentTime),n.gain.linearRampToValueAtTime(.1,e.currentTime+.01),n.gain.exponentialRampToValueAtTime(.01,e.currentTime+.2),t.start(e.currentTime),t.stop(e.currentTime+.2)}catch(e){console.log("Could not play notification sound:",e)}}c.length;async function r(){try{const e=await fetch("/api/conversation-unread-counts");if(e.ok){const{counts:t}=await e.json();c.forEach(n=>{const o=n.getAttribute("data-conversation-id"),s=n.querySelector(".notification-dot"),l=t[o]||0;l>0?s&&(s.textContent=l>99?"99+":l.toString(),s.classList.remove("hidden")):s&&s.classList.add("hidden")})}}catch(e){console.log("Error updating unread counts:",e)}}async function E(){try{const{data:{session:e}}=await v.auth.getSession();if(!e)return;const{data:t}=await v.from("conversation_participants").select("conversation_id").eq("user_id",e.user.id);if(!t)return;const n=t.map(s=>s.conversation_id),{data:o}=await v.from("messages").select("conversation_id, sender_id, created_at").in("conversation_id",n).neq("sender_id",e.user.id).gte("created_at",new Date(Date.now()-3e4).toISOString()).order("created_at",{ascending:!1});if(o&&o.length>0){const s=localStorage.getItem("lastInboxCheck"),l=Date.now();(!s||l-parseInt(s)>3e4)&&y(),localStorage.setItem("lastInboxCheck",l.toString()),r(),setTimeout(()=>{document.visibilityState==="visible"&&window.location.reload()},5e3)}}catch(e){console.log("Error checking for new messages:",e)}}setInterval(r,1e4),setInterval(E,15e3),v.channel("inbox_updates").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},e=>{console.log("New message received:",e),y(),I(),r(),setTimeout(()=>{document.visibilityState==="visible"&&window.location.reload()},3e3)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"message_reads"},e=>{console.log("Message read status updated:",e),r()}).subscribe();function I(){window.showNotification&&window.showNotification("New message received!","success",3e3)}console.log("Inbox loaded with",c.length,"conversations");const u=document.getElementById("new-message-btn"),i=document.getElementById("new-message-modal"),b=document.getElementById("close-modal-btn"),m=document.getElementById("cancel-message-btn"),d=document.getElementById("user-search-input"),f=document.getElementById("user-search-results"),L=document.getElementById("user-search-loading"),g=document.getElementById("user-search-empty"),x=document.getElementById("user-search-list"),S=document.getElementById("selected-user"),T=document.getElementById("selected-user-avatar"),k=document.getElementById("selected-user-name"),C=document.getElementById("selected-user-username"),N=document.getElementById("remove-selected-user"),w=document.getElementById("message-input"),h=document.getElementById("send-message-btn");let p=null,B;u?.addEventListener("click",()=>{i.classList.remove("hidden"),d.focus()});function _(){i.classList.add("hidden"),q()}b?.addEventListener("click",_),m?.addEventListener("click",_);function q(){d.value="",w.value="",p=null,S.classList.add("hidden"),f.classList.add("hidden"),x.innerHTML=""}d?.addEventListener("input",e=>{const t=e.target.value.trim();if(clearTimeout(B),t.length<2){f.classList.add("hidden");return}B=setTimeout(()=>{A(t)},300)});async function A(e){f.classList.remove("hidden"),L.classList.remove("hidden"),g.classList.add("hidden"),x.innerHTML="";try{const n=await(await fetch(`/api/search-users?q=${encodeURIComponent(e)}`)).json();L.classList.add("hidden"),n.users&&n.users.length>0?(g.classList.add("hidden"),n.users.forEach(o=>{const s=document.createElement("button");s.type="button",s.className="w-full flex items-center gap-3 px-4 py-3 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors text-left",s.innerHTML=`
            <img src="${o.avatar}" alt="${o.displayName}" class="w-8 h-8 rounded-full object-cover" />
            <div class="flex-1 min-w-0">
              <div class="font-medium text-neutral-900 dark:text-white truncate">${o.displayName}</div>
              <div class="text-xs text-neutral-500 truncate">@${o.username}</div>
            </div>
          `,s.addEventListener("click",()=>{U(o)}),x.appendChild(s)})):g.classList.remove("hidden")}catch(t){console.error("User search error:",t),L.classList.add("hidden"),g.classList.remove("hidden"),g.textContent="Search failed. Please try again."}}function U(e){p=e.id,T.src=e.avatar,k.textContent=e.displayName,C.textContent=`@${e.username}`,S.classList.remove("hidden"),f.classList.add("hidden"),d.value="",w.focus()}N?.addEventListener("click",()=>{p=null,S.classList.add("hidden"),d.focus()}),h?.addEventListener("click",async()=>{if(!p||!w.value.trim()){alert("Please select a user and enter a message.");return}h.disabled=!0,h.textContent="Sending...";try{const e=await fetch("/api/create-conversation",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target_user_id:p,initial_message:w.value.trim()})});let t;try{t=await e.json()}catch{const o=await e.text();throw console.error("Non-JSON response:",o),new Error(`Server returned non-JSON response: ${o.substring(0,100)}...`)}if(e.ok)window.location.href=`/inbox/${t.conversation_id}`;else{if(t.requiresEncryption&&confirm(`Encryption setup is required to start conversations.

This ensures your messages are secure and private.

Would you like to set up encryption now?`)){window.location.href="/encryption-status";return}throw new Error(t.error||"Failed to create conversation")}}catch(e){console.error("Error creating conversation:",e),alert("Failed to send message: "+e.message),h.disabled=!1,h.textContent="Send Message"}}),i?.addEventListener("click",e=>{e.target===i&&_()})}
