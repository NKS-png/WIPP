---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';

// Get conversation ID from URL params
const conversationId = Astro.url.searchParams.get('id');

if (!conversationId) {
  return Astro.redirect('/inbox');
}

// Get session from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  const { data } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  currentUser = data.session?.user;
}

if (!currentUser) {
  return Astro.redirect('/login');
}

// Get conversation details
const { data: conversation } = await supabase
  .from('conversations')
  .select('*')
  .eq('id', conversationId)
  .single();

if (!conversation) {
  return Astro.redirect('/inbox');
}

// Get messages
const { data: messages } = await supabase
  .from('messages')
  .select('*')
  .eq('conversation_id', conversationId)
  .order('created_at', { ascending: true });
---

<BaseLayout title="Simple Chat">
  <div class="max-w-4xl mx-auto py-8">
    <div class="mb-4">
      <a href="/inbox" class="text-blue-600 hover:text-blue-800">‚Üê Back to Inbox</a>
    </div>
    
    <h1 class="text-3xl font-bold mb-8">Simple Chat Test</h1>
    
    <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">Conversation: {conversationId}</h2>
      
      <div class="space-y-4 mb-6 max-h-96 overflow-y-auto">
        {messages && messages.length > 0 ? (
          messages.map((msg) => (
            <div class={`p-3 rounded-lg ${msg.sender_id === currentUser.id ? 'bg-blue-100 ml-8' : 'bg-gray-100 mr-8'}`}>
              <div class="text-sm text-gray-600 mb-1">
                {msg.sender_id === currentUser.id ? 'You' : 'Other User'} - {new Date(msg.created_at).toLocaleString()}
              </div>
              <div>{msg.content}</div>
            </div>
          ))
        ) : (
          <div class="text-gray-500 text-center py-8">No messages yet</div>
        )}
      </div>
      
      <form id="simple-message-form" class="flex gap-2">
        <input 
          type="text" 
          id="simple-message-input" 
          placeholder="Type a message..." 
          class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          required
        />
        <button 
          type="submit" 
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          Send
        </button>
      </form>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ conversationId, currentUserId: currentUser?.id }}>
  // Simple message sending without dynamic imports
  const form = document.getElementById('simple-message-form');
  const input = document.getElementById('simple-message-input');
  
  if (form && input) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = input.value.trim();
      if (!content) return;
      
      try {
        const response = await fetch('/api/send-message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            conversation_id: conversationId,
            content: content
          })
        });
        
        if (response.ok) {
          // Reload page to show new message
          window.location.reload();
        } else {
          const errorData = await response.json();
          alert('Failed to send message: ' + (errorData.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Failed to send message: ' + error.message);
      }
    });
  }
</script>
</BaseLayout>