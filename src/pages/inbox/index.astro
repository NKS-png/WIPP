---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { supabase } from '../../lib/supabase';

// Get session from cookies
const accessToken = Astro.cookies.get('sb-access-token')?.value;
const refreshToken = Astro.cookies.get('sb-refresh-token')?.value;

let currentUser = null;
if (accessToken && refreshToken) {
  const { data } = await supabase.auth.setSession({
    access_token: accessToken,
    refresh_token: refreshToken,
  });
  currentUser = data.session?.user;
}

// Redirect if not logged in
if (!currentUser) {
  return Astro.redirect('/login');
}

// Get conversations using simplified approach
const { data: myParticipations } = await supabase
  .from('conversation_participants')
  .select('conversation_id')
  .eq('user_id', currentUser.id);

console.log('My participations:', myParticipations);

let conversationDetails = [];

if (myParticipations && myParticipations.length > 0) {
  const conversationIds = myParticipations.map(p => p.conversation_id);
  
  // Get conversation details
  const { data: conversations } = await supabase
    .from('conversations')
    .select('*')
    .in('id', conversationIds)
    .order('updated_at', { ascending: false });

  console.log('Conversations:', conversations);

  // Get details for each conversation
  conversationDetails = await Promise.all(
    (conversations || []).map(async (conv) => {
      // First, check if this conversation has any messages
      const { count: messageCount } = await supabase
        .from('messages')
        .select('*', { count: 'exact', head: true })
        .eq('conversation_id', conv.id);

      // Skip conversations with no messages
      if (!messageCount || messageCount === 0) {
        return null;
      }

      // Get other participant
      const { data: otherParticipants } = await supabase
        .from('conversation_participants')
        .select('user_id')
        .eq('conversation_id', conv.id)
        .neq('user_id', currentUser.id);

      let partner = null;
      if (otherParticipants && otherParticipants.length > 0) {
        const { data: partnerProfile } = await supabase
          .from('profiles')
          .select('id, username, full_name, avatar_url')
          .eq('id', otherParticipants[0].user_id)
          .single();
        partner = partnerProfile;
      }

      // Get last message
      const { data: lastMessage } = await supabase
        .from('messages')
        .select('*')
        .eq('conversation_id', conv.id)
        .order('created_at', { ascending: false })
        .limit(1)
        .single();

      // Count unread messages (messages not sent by current user)
      const { count: unreadCount } = await supabase
        .from('messages')
        .select('*', { count: 'exact', head: true })
        .eq('conversation_id', conv.id)
        .neq('sender_id', currentUser.id);

      return {
        id: conv.id,
        partner: partner,
        lastMessage: lastMessage,
        unreadCount: unreadCount || 0,
        updatedAt: conv.updated_at || conv.created_at,
        messageCount: messageCount
      };
    })
  );

  // Filter out null results (conversations with no messages) and conversations without valid partners
  conversationDetails = conversationDetails.filter(c => c !== null && c.partner);
}

// Filter conversations and sort by most recent
const sortedConversations = conversationDetails
  .sort((a, b) => new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime());

console.log('Final conversations (with messages only):', sortedConversations);
---

<BaseLayout title="Inbox">
  <div class="min-h-screen bg-neutral-50 dark:bg-black">
    <div class="max-w-5xl mx-auto px-4 py-8">
      
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-4xl font-black text-neutral-900 dark:text-white mb-2">
          Messages
        </h1>
        <p class="text-neutral-500 dark:text-neutral-400">
          {sortedConversations.length} conversation{sortedConversations.length !== 1 ? 's' : ''}
        </p>
      </div>

      <!-- Search & Filter Bar -->
      <div class="mb-6 flex items-center gap-4">
        <div class="flex-1 relative">
          <input
            type="text"
            id="search-input"
            placeholder="Search conversations..."
            class="w-full px-5 py-3 pl-12 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl focus:outline-none focus:ring-2 focus:ring-purple-500 dark:text-white placeholder-neutral-400"
          />
          <svg class="w-5 h-5 absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        
        <button 
          onclick="window.location.reload()" 
          class="px-5 py-3 bg-neutral-200 dark:bg-neutral-800 text-neutral-700 dark:text-neutral-300 rounded-2xl font-semibold hover:bg-neutral-300 dark:hover:bg-neutral-700 transition flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span class="hidden md:inline">Refresh</span>
        </button>
        
        <button class="px-5 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl font-semibold hover:shadow-lg transition flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          <span class="hidden md:inline">New Message</span>
        </button>
      </div>

      <!-- Conversations List -->
      <div class="space-y-3" id="conversations-list">
        {sortedConversations.length > 0 ? (
          sortedConversations.map((conv) => {
            const partner = conv.partner;
            const displayName = partner?.full_name || partner?.username || 'Unknown User';
            const displayAvatar = partner?.avatar_url || `https://api.dicebear.com/7.x/initials/svg?seed=${displayName}`;
            const lastMsg = conv.lastMessage;
            const isUnread = conv.unreadCount > 0;
            const isSentByMe = lastMsg?.sender_id === currentUser.id;

            return (
              <a
                href={`/inbox/${conv.id}`}
                class="block bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-2xl p-5 hover:border-purple-500 dark:hover:border-purple-400 transition-all hover:shadow-lg conversation-item"
                data-conversation-id={conv.id}
              >
                <div class="flex items-center gap-4">
                  <!-- Avatar -->
                  <div class="relative flex-shrink-0">
                    <img
                      src={displayAvatar}
                      alt={displayName}
                      class="w-14 h-14 rounded-full object-cover border-2 border-neutral-100 dark:border-neutral-800"
                    />
                    {isUnread && (
                      <div class="absolute -top-1 -right-1 w-5 h-5 bg-purple-600 border-2 border-white dark:border-neutral-900 rounded-full flex items-center justify-center">
                        <span class="text-white text-xs font-bold">{conv.unreadCount}</span>
                      </div>
                    )}
                  </div>

                  <!-- Content -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                      <h3 class={`font-bold text-neutral-900 dark:text-white truncate ${isUnread ? 'text-lg' : 'text-base'}`}>
                        {displayName}
                      </h3>
                      {lastMsg && (
                        <span class="text-xs text-neutral-400 dark:text-neutral-500 flex-shrink-0 ml-2">
                          {new Date(lastMsg.created_at).toLocaleDateString() === new Date().toLocaleDateString()
                            ? new Date(lastMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                            : new Date(lastMsg.created_at).toLocaleDateString([], { month: 'short', day: 'numeric' })
                          }
                        </span>
                      )}
                    </div>
                    
                    {lastMsg ? (
                      <p class={`text-sm truncate ${isUnread ? 'text-neutral-900 dark:text-white font-semibold' : 'text-neutral-500 dark:text-neutral-400'}`}>
                        {isSentByMe && <span class="text-neutral-400 mr-1">You:</span>}
                        {lastMsg.content}
                      </p>
                    ) : (
                      <p class="text-sm text-neutral-400 italic">No messages yet</p>
                    )}
                  </div>

                  <!-- Arrow Icon -->
                  <svg class="w-5 h-5 text-neutral-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </a>
            );
          })
        ) : (
          <!-- Empty State -->
          <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-3xl p-16 text-center">
            <div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-6">
              <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
              </svg>
            </div>
            <h3 class="text-2xl font-bold text-neutral-900 dark:text-white mb-3">
              No messages yet
            </h3>
            <p class="text-neutral-500 dark:text-neutral-400 mb-6 max-w-md mx-auto">
              Start a conversation by visiting a user's profile and clicking "Message"
            </p>
            <a
              href="/explore"
              class="inline-block px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full font-semibold hover:shadow-lg transition"
            >
              Explore Wipp
            </a>
          </div>
        )}
      </div>

    </div>
  </div>
</BaseLayout>

<script>
  // Search functionality
  const searchInput = document.getElementById('search-input');
  const conversationItems = document.querySelectorAll('.conversation-item');

  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      
      conversationItems.forEach((item) => {
        const text = item.textContent?.toLowerCase() || '';
        if (text.includes(query)) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
  }

  // Simple auto-refresh for new messages (every 30 seconds)
  setInterval(() => {
    // Only refresh if user is active (not in background)
    if (document.visibilityState === 'visible') {
      window.location.reload();
    }
  }, 30000); // 30 seconds

  console.log('Inbox loaded with', conversationItems.length, 'conversations');
</script>

<style>
  /* Smooth animations */
  .conversation-item {
    animation: fadeInUp 0.3s ease-out forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Stagger animation */
  .conversation-item:nth-child(1) { animation-delay: 0s; }
  .conversation-item:nth-child(2) { animation-delay: 0.05s; }
  .conversation-item:nth-child(3) { animation-delay: 0.1s; }
  .conversation-item:nth-child(4) { animation-delay: 0.15s; }
  .conversation-item:nth-child(5) { animation-delay: 0.2s; }
</style>